<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ù†Ø§ÙØ³</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Tajawal','Segoe UI',sans-serif;background:linear-gradient(135deg,#4472C4,#764ba2);min-height:100vh;padding:20px}
        .container{max-width:1400px;margin:0 auto}
        .header{text-align:center;background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;padding:40px;border-radius:15px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
        .header h1{font-size:2.5em;margin-bottom:10px}
        .card{background:#fff;border-radius:15px;padding:30px;margin-bottom:20px;box-shadow:0 10px 40px rgba(0,0,0,.1)}
        .targets-section{background:#f0f4ff;border:2px solid #4472C4;border-radius:12px;padding:25px}
        .targets-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-top:20px}
        .target-input{background:#fff;padding:20px;border-radius:10px;border:2px solid #e0e0e0}
        .target-input h4{color:#4472C4;margin-bottom:15px}
        .target-input label{display:block;margin-bottom:8px;font-weight:700;color:#333}
        .target-input input{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1.1em;font-family:'Tajawal',sans-serif}
        .upload-area{border:3px dashed #4472C4;border-radius:12px;padding:50px;text-align:center;cursor:pointer;transition:.3s;background:rgba(68,114,196,.05)}
        .upload-area:hover,.upload-area.dragover{background:rgba(68,114,196,.15)}
        .upload-icon{font-size:5em;margin-bottom:20px}
        .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:20px 0}
        .stat-card{color:#fff;padding:25px;border-radius:12px;text-align:center;box-shadow:0 5px 20px rgba(0,0,0,.1)}
        .stat-card.improved{background:linear-gradient(135deg,#28a745,#20c997)}
        .stat-card.declined{background:linear-gradient(135deg,#dc3545,#c82333)}
        .stat-card.neutral{background:linear-gradient(135deg,#ffc107,#e0a800)}
        .stat-card h3{font-size:2.5em;margin-bottom:5px}
        .stat-card .comparison{font-size:.85em;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.3)}
        .stat-card .trend{font-size:.9em;margin-top:5px;font-weight:700}
        .comparison-table{width:100%;margin:20px 0;border-collapse:collapse}
        .comparison-table th,.comparison-table td{padding:15px;text-align:center;border:2px solid #e0e0e0}
        .comparison-table th{background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;font-weight:700}
        .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0}
        .form-group label{display:block;margin-bottom:10px;font-weight:700;color:#333}
        .form-group select{width:100%;padding:15px;border:2px solid #e0e0e0;border-radius:8px;font-size:1.1em;font-family:'Tajawal',sans-serif}
        .btn{padding:15px 40px;background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;border:none;border-radius:10px;font-size:1.1em;font-weight:700;cursor:pointer;margin:10px 5px;transition:.3s;font-family:'Tajawal',sans-serif}
        .btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(68,114,196,.4)}
        .btn-success{background:linear-gradient(135deg,#28a745,#20c997)}
        .btn-pdf{background:linear-gradient(135deg,#dc3545,#c82333)}
        .chart-container{position:relative;height:400px;margin:30px 0;padding:25px;background:#f9f9f9;border-radius:10px}
        .tabs{display:flex;gap:10px;margin-bottom:25px;flex-wrap:wrap}
        .tab{padding:15px 30px;background:#f0f0f0;border:none;border-radius:10px;cursor:pointer;font-size:1.1em;font-weight:700;transition:.3s;font-family:'Tajawal',sans-serif}
        .tab.active{background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff}
        .tab-content{display:none}.tab-content.active{display:block}
        .report-section{margin-bottom:30px}
        .report-header{text-align:center;padding:30px;background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;border-radius:10px;margin-bottom:30px}
        .report-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin:20px 0}
        .report-stat{background:#f8f9fa;padding:15px;border-radius:8px;text-align:center;border:2px solid #e0e0e0}
        .strengths-box{background:#d4edda;border:2px solid #28a745;border-radius:10px;padding:20px;margin:20px 0}
        .strengths-box h3{color:#155724;margin-bottom:15px}
        .strengths-box ul{list-style:none;padding:0}
        .strengths-box li{padding:10px 0;border-bottom:1px solid #c3e6cb}
        .strengths-box li:before{content:"âœ… ";margin-left:10px}
        .weaknesses-box{background:#f8d7da;border:2px solid #dc3545;border-radius:10px;padding:20px;margin:20px 0}
        .weaknesses-box h3{color:#721c24;margin-bottom:15px}
        .weaknesses-box ul{list-style:none;padding:0}
        .weaknesses-box li{padding:10px 0;border-bottom:1px solid #f5c6cb}
        .weaknesses-box li:before{content:"âš ï¸ ";margin-left:10px}
        .recommendations-box{background:#fff3cd;border:2px solid #ffc107;border-radius:10px;padding:20px;margin:20px 0}
        .recommendations-box h3{color:#856404;margin-bottom:15px}
        .recommendations-box ol{padding-right:20px}
        .recommendations-box li{padding:10px 0;border-bottom:1px solid #ffeaa7}
        .alert{padding:20px;border-radius:10px;margin:20px 0;font-size:1.1em}
        .alert-info{background:#d1ecf1;border:2px solid #bee5eb;color:#0c5460}
        .alert-success{background:#d4edda;border:2px solid #c3e6cb;color:#155724}
        .alert-warning{background:#fff3cd;border:2px solid #ffc107;color:#856404}
        .spinner{border:5px solid rgba(255,255,255,.3);border-top:5px solid #4472C4;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin:30px auto;display:none}
        .spinner.show{display:block}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .hidden{display:none!important}
        .pdf-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:9999}
        .pdf-overlay-content{background:#fff;border-radius:15px;padding:40px;text-align:center;max-width:400px}
        .pdf-overlay-content h3{color:#4472C4;margin-bottom:15px}
        .pdf-progress{width:100%;height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden;margin-top:15px}
        .pdf-progress-bar{height:100%;background:linear-gradient(135deg,#4472C4,#764ba2);border-radius:4px;animation:prog 2s ease-in-out infinite;width:60%}
        @keyframes prog{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}
        .report-chart-img{width:100%;max-width:700px;height:auto;display:block;margin:15px auto;border-radius:8px}
        #chartFactory{position:fixed;left:-9999px;top:0;width:800px;height:600px;pointer-events:none;opacity:0}
        /* Ranking Styles */
        .ranking-header{text-align:center;margin-bottom:30px}
        .ranking-header h2{color:#4472C4;font-size:1.8em;margin-bottom:10px}
        .ranking-header p{color:#666;font-size:1.1em}
        .ranking-filters{display:flex;gap:15px;justify-content:center;margin:20px 0;flex-wrap:wrap}
        .ranking-filter-btn{padding:10px 25px;border:2px solid #4472C4;background:#fff;color:#4472C4;border-radius:25px;cursor:pointer;font-weight:700;font-size:1em;font-family:'Tajawal',sans-serif;transition:.3s}
        .ranking-filter-btn.active{background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;border-color:transparent}
        .ranking-grid{display:grid;grid-template-columns:1fr 1fr;gap:25px;margin:25px 0}
        .ranking-card{border-radius:15px;overflow:hidden;box-shadow:0 5px 20px rgba(0,0,0,.08)}
        .ranking-card-header{padding:20px;color:#fff;text-align:center;font-size:1.2em;font-weight:700}
        .ranking-card-header.top{background:linear-gradient(135deg,#28a745,#20c997)}
        .ranking-card-header.bottom{background:linear-gradient(135deg,#dc3545,#c82333)}
        .ranking-card-header.improved{background:linear-gradient(135deg,#17a2b8,#138496)}
        .ranking-card-header.declined{background:linear-gradient(135deg,#fd7e14,#e8590c)}
        .ranking-list{list-style:none;padding:0;margin:0}
        .ranking-item{display:flex;align-items:center;padding:12px 20px;border-bottom:1px solid #f0f0f0;transition:.2s}
        .ranking-item:hover{background:#f8f9fa}
        .ranking-item:last-child{border-bottom:none}
        .rank-num{width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.95em;margin-left:15px;flex-shrink:0}
        .rank-num.gold{background:linear-gradient(135deg,#ffd700,#ffb300);color:#fff}
        .rank-num.silver{background:linear-gradient(135deg,#c0c0c0,#a0a0a0);color:#fff}
        .rank-num.bronze{background:linear-gradient(135deg,#cd7f32,#b8650a);color:#fff}
        .rank-num.normal{background:#e9ecef;color:#495057}
        .rank-num.bad{background:#f8d7da;color:#721c24}
        .rank-info{flex:1;min-width:0}
        .rank-name{font-weight:700;color:#333;font-size:.95em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .rank-detail{font-size:.8em;color:#888;margin-top:3px}
        .rank-score{font-weight:900;font-size:1.3em;margin-right:10px;flex-shrink:0}
        .rank-score.high{color:#28a745}
        .rank-score.low{color:#dc3545}
        .rank-score.mid{color:#ffc107}
        .rank-change{display:flex;align-items:center;gap:5px;font-weight:700;font-size:.95em;margin-right:10px;flex-shrink:0;min-width:70px;justify-content:flex-end}
        .rank-change.up{color:#28a745}
        .rank-change.down{color:#dc3545}
        .rank-change.same{color:#888}
        .change-arrow{font-size:1.2em}
        .ranking-section-full{margin:30px 0}
        .ranking-section-full .ranking-card{margin-bottom:0}
        @media(max-width:900px){.ranking-grid{grid-template-columns:1fr}}
        .no-print{} /* placeholder */
        @media print{.no-print{display:none!important}}

        /* === RESPONSIVE === */
        /* Tablet */
        @media(max-width:1024px){
            body{padding:12px}
            .container{max-width:100%}
            .card{padding:20px;margin-bottom:15px}
            .header{padding:30px 20px}
            .header h1{font-size:2em}
            .chart-container{height:350px;padding:15px;margin:20px 0}
            .comparison-table th,.comparison-table td{padding:10px;font-size:.9em}
            .ranking-item{padding:10px 15px}
            .rank-score{font-size:1.1em}
        }

        /* Mobile */
        @media(max-width:768px){
            body{padding:8px}
            .header{padding:20px 15px;border-radius:10px;margin-bottom:15px}
            .header h1{font-size:1.5em;line-height:1.4}
            .header p{font-size:1em}
            .card{padding:15px;border-radius:10px;margin-bottom:12px}
            .targets-section{padding:15px}
            .targets-grid{grid-template-columns:1fr;gap:12px}
            .target-input{padding:15px}
            .dashboard{grid-template-columns:1fr;gap:12px}
            .stat-card{padding:18px}
            .stat-card h3{font-size:2em}
            .stat-card .comparison{font-size:.8em}
            .controls{grid-template-columns:1fr;gap:12px}
            .form-group select{padding:12px;font-size:1em}
            .btn{padding:12px 20px;font-size:1em;margin:5px 3px;width:100%;text-align:center}
            .tabs{gap:6px;justify-content:center}
            .tab{padding:10px 14px;font-size:.9em;flex:1;text-align:center;min-width:0}
            .chart-container{height:300px;padding:10px;margin:15px 0}
            .report-stats{grid-template-columns:1fr;gap:10px}
            .report-header h1{font-size:1.4em}
            .report-header h2{font-size:1.1em}
            .report-header h3{font-size:1em}
            .strengths-box,.weaknesses-box,.recommendations-box{padding:15px;margin:12px 0}
            .strengths-box h3,.weaknesses-box h3,.recommendations-box h3{font-size:1.1em}
            .strengths-box li,.weaknesses-box li,.recommendations-box li{padding:8px 0;font-size:.9em}
            .comparison-table{font-size:.8em;display:block;overflow-x:auto;white-space:nowrap}
            .comparison-table th,.comparison-table td{padding:8px 6px}
            .upload-area{padding:30px 15px}
            .upload-icon{font-size:3em;margin-bottom:10px}
            .upload-area h2{font-size:1.2em}
            .ranking-header h2{font-size:1.3em}
            .ranking-grid{grid-template-columns:1fr;gap:15px}
            .ranking-item{padding:10px 12px}
            .rank-num{width:30px;height:30px;font-size:.85em;margin-left:10px}
            .rank-name{font-size:.85em}
            .rank-score{font-size:1.1em;margin-right:5px}
            .rank-change{font-size:.8em;min-width:60px}
            .rank-detail{font-size:.75em}
            .ranking-card-header{padding:15px;font-size:1em}
            .pdf-overlay-content{margin:15px;padding:25px}
            .alert{padding:15px;font-size:1em}
        }

        /* Small Mobile */
        @media(max-width:480px){
            body{padding:5px}
            .header{padding:15px 10px}
            .header h1{font-size:1.25em}
            .card{padding:12px;border-radius:8px}
            .stat-card h3{font-size:1.7em}
            .tab{padding:8px 10px;font-size:.8em}
            .chart-container{height:250px;padding:8px}
            .btn{padding:10px 15px;font-size:.9em}
            .report-stat h2{font-size:1.8em!important}
            .comparison-table th,.comparison-table td{padding:6px 4px;font-size:.75em}
            .ranking-item{flex-wrap:wrap;gap:5px}
            .rank-info{flex-basis:calc(100% - 50px)}
        }
        /* Search Select */
        .search-select-wrap{position:relative;width:100%}
        .search-select-input{width:100%;padding:15px;border:2px solid #e0e0e0;border-radius:8px;font-size:1.1em;font-family:'Tajawal',sans-serif;cursor:pointer;background:#fff}
        .search-select-input:focus{border-color:#4472C4;outline:none;box-shadow:0 0 0 3px rgba(68,114,196,.15)}
        .search-select-dropdown{display:none;position:absolute;top:100%;right:0;left:0;background:#fff;border:2px solid #4472C4;border-radius:0 0 10px 10px;max-height:300px;overflow-y:auto;z-index:100;box-shadow:0 10px 30px rgba(0,0,0,.15)}
        .search-select-dropdown.open{display:block}
        .search-select-search{width:100%;padding:12px 15px;border:none;border-bottom:2px solid #e0e0e0;font-size:1em;font-family:'Tajawal',sans-serif;outline:none;position:sticky;top:0;background:#fff}
        .search-select-option{padding:12px 15px;cursor:pointer;transition:.15s;border-bottom:1px solid #f0f0f0}
        .search-select-option:hover,.search-select-option.highlighted{background:#e8f0fe;color:#4472C4}
        .search-select-option.selected{background:#4472C4;color:#fff;font-weight:700}
        .search-select-empty{padding:15px;text-align:center;color:#999}
        /* Ranking Subject Tabs */
        .ranking-subj-tabs{display:flex;gap:8px;justify-content:center;margin:15px 0 25px;flex-wrap:wrap}
        .ranking-subj-btn{padding:10px 25px;border:2px solid #4472C4;background:#fff;color:#4472C4;border-radius:25px;cursor:pointer;font-weight:700;font-size:1em;font-family:'Tajawal',sans-serif;transition:.3s}
        .ranking-subj-btn:hover{background:rgba(68,114,196,.1)}
        .ranking-subj-btn.active{background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;border-color:transparent;box-shadow:0 4px 15px rgba(68,114,196,.3)}
        @media(max-width:768px){.ranking-subj-btn{padding:8px 16px;font-size:.9em}.search-select-input{padding:12px;font-size:1em}}
    </style>
</head>
<body>
<div id="chartFactory"></div>
<div class="container">
    <div class="header no-print"><h1>ğŸ“Š Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ© ( Ù†Ø§ÙØ³ )</h1><p style="font-size:1.2em"> Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù…Ø¹ ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„Ø¶Ø¹Ù ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡</p><div id="quickActions" style="display:none;margin-top:20px"><button class="btn" onclick="document.getElementById('targetsCard').style.display='block';document.getElementById('targetsCard').scrollIntoView({behavior:'smooth'})">âš™ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª</button> <button class="btn" onclick="showUploadArea();document.getElementById('uploadCard').scrollIntoView({behavior:'smooth'})">ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù Excel Ø¬Ø¯ÙŠØ¯</button></div></div>
    <div class="card no-print" id="targetsCard"><div class="targets-section"><h2 style="color:#4472C4;margin-bottom:20px">ğŸ¯ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø©</h2><p style="margin-bottom:20px;color:#666">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø©</p><div class="targets-grid"><div class="target-input"><h4>ğŸ“ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</h4><label>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (%)</label><input type="number" id="targetMath" value="50" min="0" max="100"></div><div class="target-input"><h4>ğŸ“– Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</h4><label>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (%)</label><input type="number" id="targetReading" value="55" min="0" max="100"></div><div class="target-input"><h4>ğŸ”¬ Ø§Ù„Ø¹Ù„ÙˆÙ…</h4><label>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (%)</label><input type="number" id="targetScience" value="60" min="0" max="100"></div></div><div style="text-align:center;margin-top:20px"><button class="btn btn-success" onclick="saveTargets()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª</button></div></div></div>
    <div class="card no-print" id="uploadCard" style="display:none"><h2 style="color:#4472C4;margin-bottom:25px;text-align:center">ğŸ“ Ø§Ø±ÙØ¹ Ù…Ù„Ù Ù†Ø§ÙØ³</h2><div class="alert alert-info"><strong>ğŸ’¡</strong> Ø§Ø±ÙØ¹ Ù…Ù„Ù Ù†Ø§ÙØ³ Ø§Ù„Ø±Ø³Ù…ÙŠ (.xlsx)</div><div class="upload-area" id="uploadArea"><div class="upload-icon">ğŸ“¤</div><h2>Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ù‡Ù†Ø§</h2><p style="font-size:1.2em;margin:15px 0">Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p><input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none"></div><div class="spinner" id="spinner"></div><div id="status"></div></div>
    <div class="card hidden no-print" id="dashboardCard"><h2 style="color:#4472C4;margin-bottom:20px">ğŸ“ˆ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… <span id="currentYear"></span></h2><div class="dashboard" id="stats"></div></div>
    <div class="card hidden no-print" id="comparisonCard"><h2 style="color:#4472C4;margin-bottom:20px">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</h2><div id="comparisonTableContainer"></div></div>
    <div class="card hidden no-print" id="controlsCard"><h2 style="color:#4472C4;margin-bottom:20px">âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶</h2><div class="controls"><div class="form-group"><label>ğŸ“š Ø§Ù„Ù…Ø§Ø¯Ø©</label><select id="subjectSelect" onchange="updateView()"><option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option></select></div><div class="form-group"><label>ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><div class="search-select-wrap" id="schoolSearchWrap"><input type="text" class="search-select-input" id="schoolSearchInput" placeholder="Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø© Ø£Ùˆ Ø§Ø¨Ø­Ø«..." readonly onclick="toggleSchoolDropdown()"><div class="search-select-dropdown" id="schoolDropdown"><input type="text" class="search-select-search" id="schoolSearchFilter" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³Ø©..." oninput="filterSchoolList()"><div id="schoolOptionsList"></div></div></div></div></div></div>
    <div class="card hidden" id="mainCard">
        <div class="tabs no-print"><button class="tab active" onclick="switchTab(0)">ğŸ“Š Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª</button><button class="tab" onclick="switchTab(1)">ğŸ“„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„</button><button class="tab" onclick="switchTab(2)">ğŸ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</button></div>
        <div class="tab-content active" id="tab0"><div id="chartsContent"></div></div>
        <div class="tab-content" id="tab1"><div id="reportPreview"></div><div style="text-align:center;margin-top:30px" class="no-print"><button class="btn btn-pdf" onclick="exportPDF()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF</button> <button class="btn" onclick="printReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div></div>
        <div class="tab-content" id="tab2"><div id="rankingContent"></div></div>
    </div>
</div>
<script>
var D={raw:[],school:'',subject:'all',latestYear:'',previousYear:'',charts:{},targets:{math:50,reading:55,science:60},selectedSchool:'',rankSubject:'all',schoolNames:[]};
function avg(a){if(!a||!a.length)return 0;var s=0;for(var i=0;i<a.length;i++)s+=a[i];return s/a.length}

/* === Dynamic column finder for level data === */
function getLevels(rows){
    if(!rows||!rows.length)return{h:0,m:0,l:0,vl:0,count:0};
    var keys=Object.keys(rows[0]);
    console.log('getLevels called with '+rows.length+' rows');
    console.log('All keys:', keys.join(' | '));
    
    var keyHigh=null, keyMed=null, keyLow=null, keyVLow=null;
    
    for(var i=0;i<keys.length;i++){
        var k=keys[i];
        // Strategy 1: contains both Ù…Ø³ØªÙˆÙ‰ and Ø§Ù„Ø£Ø¯Ø§Ø¡
        if(k.indexOf('Ù…Ø³ØªÙˆÙ‰')!==-1 && k.indexOf('Ø§Ù„Ø£Ø¯Ø§Ø¡')!==-1){
            if(k.indexOf('Ø§Ù„Ù…Ø±ØªÙØ¹')!==-1) keyHigh=k;
            else if(k.indexOf('Ø§Ù„Ù…Ù†Ø®ÙØ¶')!==-1){
                if(k.indexOf('Ø¬Ø¯Ø§')!==-1 || k.indexOf('Ø¬Ø¯Ø§Ù‹')!==-1) keyVLow=k;
                else keyLow=k;
            }
            else if(k.indexOf('Ø§Ù„Ù…ØªÙˆØ³Ø·')!==-1) keyMed=k;
        }
        // Strategy 2: contains Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰
        if(k.indexOf('Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨')!==-1 && k.indexOf('Ù…Ø³ØªÙˆÙ‰')!==-1){
            if(k.indexOf('Ø§Ù„Ù…Ø±ØªÙØ¹')!==-1) keyHigh=k;
            else if(k.indexOf('Ø§Ù„Ù…Ù†Ø®ÙØ¶')!==-1){
                if(k.indexOf('Ø¬Ø¯Ø§')!==-1 || k.indexOf('Ø¬Ø¯Ø§Ù‹')!==-1) keyVLow=k;
                else keyLow=k;
            }
            else if(k.indexOf('Ø§Ù„Ù…ØªÙˆØ³Ø·')!==-1) keyMed=k;
        }
    }
    
    // Strategy 3: If still not found, try partial matches
    if(!keyHigh||!keyMed||!keyLow||!keyVLow){
        for(var i=0;i<keys.length;i++){
            var k=keys[i];
            if(!keyHigh && k.indexOf('Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø±ØªÙØ¹')!==-1) keyHigh=k;
            if(!keyMed && k.indexOf('Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªÙˆØ³Ø·')!==-1) keyMed=k;
            if(!keyVLow && k.indexOf('Ø§Ù„Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§')!==-1) keyVLow=k;
            if(!keyVLow && k.indexOf('Ø§Ù„Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹')!==-1) keyVLow=k;
            if(!keyLow && k.indexOf('Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø®ÙØ¶')!==-1 && k.indexOf('Ø¬Ø¯Ø§')===-1 && k.indexOf('Ø¬Ø¯Ø§Ù‹')===-1) keyLow=k;
        }
    }
    
    console.log('Level keys:', JSON.stringify({high:keyHigh, med:keyMed, low:keyLow, vlow:keyVLow}));
    
    // If no keys found at all, show what keys contain 'Ù…Ø³ØªÙˆÙ‰' or 'Ù†Ø³Ø¨Ø©'
    if(!keyHigh && !keyMed && !keyLow && !keyVLow){
        var related=keys.filter(function(k){return k.indexOf('Ù…Ø³ØªÙˆÙ‰')!==-1||k.indexOf('Ù†Ø³Ø¨Ø©')!==-1||k.indexOf('Ø£Ø¯Ø§Ø¡')!==-1});
        console.log('No level keys found! Related keys:', related);
        return{h:0,m:0,l:0,vl:0,count:0};
    }
    
    var hArr=[],mArr=[],lArr=[],vlArr=[];
    for(var i=0;i<rows.length;i++){
        var r=rows[i];
        var hv=keyHigh?parseFloat(r[keyHigh])||0:0;
        var mv=keyMed?parseFloat(r[keyMed])||0:0;
        var lv=keyLow?parseFloat(r[keyLow])||0:0;
        var vlv=keyVLow?parseFloat(r[keyVLow])||0:0;
        if(hv>0||mv>0||lv>0||vlv>0){hArr.push(hv);mArr.push(mv);lArr.push(lv);vlArr.push(vlv)}
    }
    console.log('Level result: '+hArr.length+' records, H='+avg(hArr).toFixed(1)+' M='+avg(mArr).toFixed(1)+' L='+avg(lArr).toFixed(1)+' VL='+avg(vlArr).toFixed(1));
    return{h:avg(hArr),m:avg(mArr),l:avg(lArr),vl:avg(vlArr),count:hArr.length};
}
function getSD(bd,subj,yr){
    var ld=bd.filter(function(r){return r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']===yr});
    var ss=new Set();for(var i=0;i<bd.length;i++){var n=bd[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']||bd[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];if(n)ss.add(n)}
    var m=ss.size>1,p=0,d=0,k=0;
    if(m){var sd=ld.filter(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']===subj&&r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ']===subj});var ts=0,tp=0,sD=0,sK=0,c=0;for(var j=0;j<sd.length;j++){ts+=sd[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†']||0;tp+=sd[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†']||0;sD+=sd[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…']||0;sK+=sd[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©']||0;c++}if(ts>0){p=(tp/ts)*100;d=c>0?sD/c:0;k=c>0?sK/c:0}}
    else{var cur=ld.find(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']===subj&&r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ']===subj});if(cur){p=cur['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†']||0;d=cur['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…']||0;k=cur['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©']||0}}
    return{perf:p,dept:d,kingdom:k,isMulti:m,sc:ss.size}
}
function showStatus(m,t){var d=document.getElementById('status');if(!d)return;d.innerHTML='<div class="alert alert-'+t+'">'+m+'</div>';setTimeout(function(){d.innerHTML=''},5000)}
function switchTab(i){var t=document.querySelectorAll('.tab'),c=document.querySelectorAll('.tab-content');for(var j=0;j<t.length;j++){t[j].classList.toggle('active',j===i);c[j].classList.toggle('active',j===i)}}

/* === CHART TO IMAGE ENGINE === */
function renderChartToImage(cfg,w,h){
    return new Promise(function(resolve){
        var factory=document.getElementById('chartFactory');
        factory.innerHTML='';
        var cw=w||800,ch=h||400;
        // Make factory visible with exact dimensions so Chart.js can measure
        factory.style.cssText='position:fixed;left:0;top:0;width:'+cw+'px;height:'+ch+'px;opacity:0;pointer-events:none;z-index:-1;overflow:hidden;';
        var wrapper=document.createElement('div');
        wrapper.style.cssText='width:'+cw+'px;height:'+ch+'px;position:relative;';
        var c=document.createElement('canvas');
        wrapper.appendChild(c);
        factory.appendChild(wrapper);
        // Use responsive mode so Chart.js fills the wrapper
        cfg.options=cfg.options||{};
        cfg.options.animation=false;
        cfg.options.responsive=true;
        cfg.options.maintainAspectRatio=false;
        cfg.options.devicePixelRatio=2;
        var chart=new Chart(c,cfg);
        setTimeout(function(){
            var imgData='';
            try{imgData=c.toDataURL('image/png',1.0)}catch(e){console.error('toDataURL error',e)}
            chart.destroy();
            factory.innerHTML='';
            factory.style.cssText='position:fixed;left:-9999px;top:0;width:800px;height:600px;pointer-events:none;opacity:0;';
            resolve(imgData);
        },800);
    });
}

/* === INIT === */
document.addEventListener('DOMContentLoaded',function(){loadTargets();setupFileUpload();autoLoadData()});
function autoLoadData(){showStatus('â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...','info');tryLoad(['nafes-data.json','data.json'],0)}
function tryLoad(src,i){
    if(i>=src.length){
        showStatus('','info');
        document.getElementById('targetsCard').style.display='none';
        document.getElementById('uploadCard').style.display='block';
        var uc=document.getElementById('uploadCard');
        uc.innerHTML='<h2 style="color:#4472C4;margin-bottom:25px;text-align:center">ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù Excel</h2><div class="upload-area" id="uploadArea"><div class="upload-icon">ğŸ“¤</div><h2>Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ù‡Ù†Ø§</h2><p style="font-size:1.2em;margin:15px 0">Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p><input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none"></div><div class="spinner" id="spinner"></div><div id="status"></div>';
        setupFileUpload();return;
    }
    fetch(src[i]).then(function(r){if(!r.ok)throw 0;return r.json()}).then(function(rows){if(!rows||!rows.length)throw 0;loadData(rows)}).catch(function(){tryLoad(src,i+1)})
}
function loadData(rows){
    D.raw=rows;
    // Debug: show available columns
    if(rows.length>0){
        var keys=Object.keys(rows[0]);
        console.log('Available columns ('+keys.length+'):',keys);
        var levelKeys=keys.filter(function(k){return k.indexOf('Ù…Ø³ØªÙˆÙ‰')!==-1});
        console.log('Level-related columns:',levelKeys);
        // Test first row values
        levelKeys.forEach(function(k){console.log('  '+k+' = '+rows[0][k])});
    }
    var ss=new Set();for(var i=0;i<rows.length;i++){var n=rows[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']||rows[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];if(n)ss.add(n)}
    var sc=ss.size;D.school=sc===1?Array.from(ss)[0]:sc>1?'Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ('+sc+' Ù…Ø¯Ø±Ø³Ø©)':'Ù†Ø§ÙØ³';
    var yrs=[...new Set(rows.map(function(r){return r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']}))].filter(Boolean).sort();
    D.latestYear=yrs[yrs.length-1];D.previousYear=yrs.length>1?yrs[yrs.length-2]:null;
    populateSelects();populateSchools();showDashboard();showComparison();
    document.getElementById('controlsCard').classList.remove('hidden');
    document.getElementById('mainCard').classList.remove('hidden');
    updateView();
    document.getElementById('targetsCard').style.display='none';
    document.getElementById('uploadCard').style.display='none';
    document.getElementById('quickActions').style.display='block';
    showStatus('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­','success');
}
function showUploadArea(){document.getElementById('uploadCard').style.display='block'}
function saveTargets(){D.targets.math=parseFloat(document.getElementById('targetMath').value)||50;D.targets.reading=parseFloat(document.getElementById('targetReading').value)||55;D.targets.science=parseFloat(document.getElementById('targetScience').value)||60;try{localStorage.setItem('nafesTargets',JSON.stringify(D.targets))}catch(e){}showStatus('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª!','success');if(D.raw.length>0)updateView()}
function loadTargets(){try{var s=localStorage.getItem('nafesTargets');if(s){D.targets=JSON.parse(s);document.getElementById('targetMath').value=D.targets.math;document.getElementById('targetReading').value=D.targets.reading;document.getElementById('targetScience').value=D.targets.science}}catch(e){}}
function setupFileUpload(){var a=document.getElementById('uploadArea'),inp=document.getElementById('fileInput');if(!a||!inp)return;a.onclick=function(){inp.click()};a.ondragover=function(e){e.preventDefault();a.classList.add('dragover')};a.ondragleave=function(){a.classList.remove('dragover')};a.ondrop=function(e){e.preventDefault();a.classList.remove('dragover');if(e.dataTransfer.files[0])processFile(e.dataTransfer.files[0])};inp.onchange=function(e){if(e.target.files[0])processFile(e.target.files[0])}}
async function processFile(file){if(!file.name.match(/\.xlsx?$/)){showStatus('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Excel','warning');return}var sp=document.getElementById('spinner');if(sp)sp.classList.add('show');showStatus('â³ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø©...','info');try{var buf=await file.arrayBuffer(),wb=XLSX.read(buf),rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);if(!rows.length)throw new Error('ÙØ§Ø±Øº');loadData(rows)}catch(err){showStatus('âŒ Ø®Ø·Ø£: '+err.message,'warning')}finally{if(sp)sp.classList.remove('show')}}
function populateSchools(){
    D.schoolNames=[];
    var s=new Set();for(var i=0;i<D.raw.length;i++){var n=D.raw[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']||D.raw[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];if(n&&typeof n==='string')s.add(n.trim())}
    D.schoolNames=Array.from(s).sort();
    D.selectedSchool='';
    renderSchoolOptions('');
    var inp=document.getElementById('schoolSearchInput');
    if(inp)inp.value=D.schoolNames.length>1?'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³':D.schoolNames[0]||'';
}
function toggleSchoolDropdown(){
    var dd=document.getElementById('schoolDropdown');
    var isOpen=dd.classList.contains('open');
    if(isOpen){dd.classList.remove('open')}
    else{dd.classList.add('open');var sf=document.getElementById('schoolSearchFilter');sf.value='';sf.focus();renderSchoolOptions('')}
}
function filterSchoolList(){
    var q=document.getElementById('schoolSearchFilter').value.trim();
    renderSchoolOptions(q);
}
function renderSchoolOptions(query){
    var list=document.getElementById('schoolOptionsList');
    if(!list)return;
    var names=D.schoolNames||[];
    var filtered=query?names.filter(function(n){return n.indexOf(query)!==-1}):names;
    var html='<div class="search-select-option'+(D.selectedSchool===''?' selected':'')+'" onclick="selectSchool(\'\')">ğŸ“Š Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</div>';
    if(filtered.length===0&&query){html+='<div class="search-select-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ "'+query+'"</div>'}
    else{for(var i=0;i<filtered.length;i++){var n=filtered[i];html+='<div class="search-select-option'+(D.selectedSchool===n?' selected':'')+'" onclick="selectSchool(\''+n.replace(/'/g,"\\'")+'\')">ğŸ« '+n+'</div>'}}
    list.innerHTML=html;
}
function selectSchool(name){
    D.selectedSchool=name;
    var inp=document.getElementById('schoolSearchInput');
    inp.value=name||'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³';
    document.getElementById('schoolDropdown').classList.remove('open');
    updateView();
}
// Close dropdown when clicking outside
document.addEventListener('click',function(e){
    var wrap=document.getElementById('schoolSearchWrap');
    if(wrap&&!wrap.contains(e.target)){document.getElementById('schoolDropdown').classList.remove('open')}
});
function populateSelects(){var subjs=[...new Set(D.raw.map(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']}))].filter(Boolean);document.getElementById('subjectSelect').innerHTML='<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option>'+subjs.map(function(s){return'<option value="'+s+'">'+s+'</option>'}).join('')}

/* === DASHBOARD === */
function showDashboard(){showDashFiltered(D.raw);document.getElementById('dashboardCard').classList.remove('hidden')}
function showDashFiltered(bd){
    var subjs=['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','Ø§Ù„Ø¹Ù„ÙˆÙ…'],tm={'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':D.targets.math,'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':D.targets.reading,'Ø§Ù„Ø¹Ù„ÙˆÙ…':D.targets.science};
    var html='';
    for(var i=0;i<subjs.length;i++){
        var s=subjs[i],sd=getSD(bd,s,D.latestYear);
        if(sd.perf>0||sd.isMulti){
            var t=tm[s],cc='neutral',tt='';
            if(D.previousYear){var prev=getSD(bd,s,D.previousYear);if(prev.perf>0){var ch=(sd.perf-prev.perf).toFixed(1);if(ch>0){cc='improved';tt='<div class="trend">ğŸ“ˆ +'+ch+'%</div>'}else if(ch<0){cc='declined';tt='<div class="trend">ğŸ“‰ '+ch+'%</div>'}else tt='<div class="trend">â¡ï¸ Ø«Ø§Ø¨Øª</div>'}}
            var dd=(sd.perf-sd.dept).toFixed(1),kd=(sd.perf-sd.kingdom).toFixed(1),td=(sd.perf-t).toFixed(1);
            html+='<div class="stat-card '+cc+'"><h3>'+sd.perf.toFixed(1)+'%</h3><p>'+s+'</p>'+tt+'<div class="comparison"><div>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: '+sd.dept.toFixed(1)+'% ('+(dd>=0?'+':'')+dd+'%)</div><div>Ø§Ù„Ù…Ù…Ù„ÙƒØ©: '+sd.kingdom.toFixed(1)+'% ('+(kd>=0?'+':'')+kd+'%)</div><div>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: '+t+'% ('+(td>=0?'+':'')+td+'%)</div></div></div>';
        }
    }
    document.getElementById('currentYear').textContent=D.latestYear;
    document.getElementById('stats').innerHTML=html;
}
function showComparison(){
    var subjs=['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','Ø§Ù„Ø¹Ù„ÙˆÙ…'],tm={'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':D.targets.math,'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':D.targets.reading,'Ø§Ù„Ø¹Ù„ÙˆÙ…':D.targets.science};
    var html='<table class="comparison-table"><thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th><th>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</th><th>Ø§Ù„ÙØ¬ÙˆØ©</th><th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th><th>Ø§Ù„Ù…Ù…Ù„ÙƒØ©</th></tr></thead><tbody>';
    for(var i=0;i<subjs.length;i++){var s=subjs[i],sd=getSD(D.raw,s,D.latestYear);if(sd.perf>0||sd.isMulti){var t=tm[s],gap=(sd.perf-t).toFixed(1),gc=gap>=0?'#d4edda':'#f8d7da';html+='<tr><td><strong>'+s+'</strong></td><td><strong>'+sd.perf.toFixed(1)+'%</strong></td><td>'+t+'%</td><td style="background:'+gc+';font-weight:700">'+(gap>=0?'+':'')+gap+'%</td><td>'+sd.dept.toFixed(1)+'%</td><td>'+sd.kingdom.toFixed(1)+'%</td></tr>'}}
    html+='</tbody></table>';
    document.getElementById('comparisonTableContainer').innerHTML=html;
    document.getElementById('comparisonCard').classList.remove('hidden');
}
function updateView(){
    D.subject=document.getElementById('subjectSelect').value;
    var sel=D.selectedSchool||'';
    var bd=D.raw;if(sel)bd=D.raw.filter(function(r){return r['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']===sel||r['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']===sel});
    showDashFiltered(bd);drawCharts(bd);generateReport(bd);generateRanking(D.raw);
}
/* === INTERACTIVE CHARTS (Tab 0) === */
function drawCharts(bd){
    var ld=bd.filter(function(r){return r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']===D.latestYear});
    var f=ld;if(D.subject!=='all')f=f.filter(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']===D.subject});
    var html='<h3 style="color:#4472C4">Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ù…Ù„ÙƒØ©</h3><div class="chart-container"><canvas id="c1"></canvas></div>';
    html+='<h3 style="color:#4472C4">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù† ÙÙŠ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©</h3><div class="chart-container"><canvas id="c2"></canvas></div>';
    html+='<h3 style="color:#4472C4">ØªÙˆØ²ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</h3><div class="chart-container"><canvas id="c3"></canvas></div>';
    html+='<h3 style="color:#4472C4">ØªØ·ÙˆØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</h3><div class="chart-container"><canvas id="c4"></canvas></div>';
    document.getElementById('chartsContent').innerHTML=html;
    setTimeout(function(){drawInteractive(f,bd)},100);
}
function drawInteractive(f,bd){
    var subjs=D.subject==='all'?['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','Ø§Ù„Ø¹Ù„ÙˆÙ…']:[D.subject],tm={'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':D.targets.math,'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':D.targets.reading,'Ø§Ù„Ø¹Ù„ÙˆÙ…':D.targets.science};
    var sD=[],dD=[],kD=[],tD=[];
    for(var i=0;i<subjs.length;i++){var sd=getSD(f,subjs[i],D.latestYear);sD.push(sd.perf);dD.push(sd.dept);kD.push(sd.kingdom);tD.push(tm[subjs[i]]||0)}
    if(D.charts.c1)D.charts.c1.destroy();
    var x=document.getElementById('c1');
    if(x)D.charts.c1=new Chart(x,{type:'bar',data:{labels:subjs,datasets:[{label:'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©',data:sD,backgroundColor:'#4472C4'},{label:'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',data:dD,backgroundColor:'#ffc107'},{label:'Ø§Ù„Ù…Ù…Ù„ÙƒØ©',data:kD,backgroundColor:'#28a745'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}}},plugins:[{id:'targetLines',afterDraw:function(chart){var ctx=chart.ctx,yScale=chart.scales.y,xScale=chart.scales.x,meta=chart.getDatasetMeta(0);ctx.save();ctx.strokeStyle='#dc3545';ctx.lineWidth=2.5;ctx.setLineDash([8,4]);for(var i=0;i<tD.length;i++){if(tD[i]>0&&meta.data[i]){var yPos=yScale.getPixelForValue(tD[i]);var bar=meta.data[i];var xStart=bar.x-bar.width/2*1.8;var xEnd=bar.x+bar.width/2*1.8;ctx.beginPath();ctx.moveTo(xStart,yPos);ctx.lineTo(xEnd,yPos);ctx.stroke();ctx.fillStyle='#dc3545';ctx.font='bold 11px Tajawal';ctx.textAlign='center';ctx.fillText(tD[i]+'%',bar.x,yPos-6)}}ctx.restore();var lx=chart.width-90,ly=15;ctx.save();ctx.strokeStyle='#dc3545';ctx.lineWidth=2;ctx.setLineDash([6,3]);ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(lx+25,ly);ctx.stroke();ctx.fillStyle='#dc3545';ctx.font='bold 12px Tajawal';ctx.textAlign='right';ctx.fillText('Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù',lx+65,ly+4);ctx.restore()}}]});
    // Domains
    var doms={};for(var i=0;i<f.length;i++){var r=f[i],d=r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'];if(d!==r['Ø§Ù„Ù…Ø¬Ø§Ù„']){if(!doms[d])doms[d]=[];doms[d].push(r['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†']||0)}}
    var lbl=Object.keys(doms),vals=lbl.map(function(l){return avg(doms[l])}),bgC=vals.map(function(v){return v>=60?'#28a745':v>=40?'#ffc107':'#dc3545'});
    if(D.charts.c2)D.charts.c2.destroy();
    var x2=document.getElementById('c2');
    if(x2)D.charts.c2=new Chart(x2,{type:'bar',data:{labels:lbl,datasets:[{label:'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù† (%)',data:vals,backgroundColor:bgC}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{beginAtZero:true,max:100}}}});
    // Levels
    var lvl=getLevels(f);
    if(D.charts.c3)D.charts.c3.destroy();
    var x3=document.getElementById('c3');
    if(x3)D.charts.c3=new Chart(x3,{type:'doughnut',data:{labels:['Ù…Ø±ØªÙØ¹','Ù…ØªÙˆØ³Ø·','Ù…Ù†Ø®ÙØ¶','Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹'],datasets:[{data:[lvl.h,lvl.m,lvl.l,lvl.vl],backgroundColor:['#28a745','#36a2eb','#ffce56','#dc3545']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}});
    // Trend
    var yrs=[...new Set(bd.map(function(r){return r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']}))].filter(Boolean).sort(),colors={'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':'#4472C4','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':'#28a745','Ø§Ù„Ø¹Ù„ÙˆÙ…':'#ffc107'},ds=[];
    for(var s=0;s<subjs.length;s++){var v=yrs.map(function(y){return getSD(bd,subjs[s],y).perf});ds.push({label:subjs[s],data:v,borderColor:colors[subjs[s]],backgroundColor:colors[subjs[s]]+'20',borderWidth:3,tension:.3,fill:true})}
    if(D.charts.c4)D.charts.c4.destroy();
    var x4=document.getElementById('c4');
    if(x4)D.charts.c4=new Chart(x4,{type:'line',data:{labels:yrs,datasets:ds},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}}}});
}

/* === ANALYSIS === */
function analyze(f,subjs,tm,isM){
    var st=[],wk=[],rc=[];
    var lvl=getLevels(f);
    
    for(var i=0;i<subjs.length;i++){
        var s=subjs[i],sd=getSD(f,s,D.latestYear),t=tm[s];
        var gap=sd.perf-t, deptGap=sd.perf-sd.dept, kingGap=sd.perf-sd.kingdom;
        
        // === Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ===
        if(sd.perf>=t) st.push(s+' Ø­Ù‚Ù‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ø¨Ù†Ø³Ø¨Ø© '+sd.perf.toFixed(1)+'% (Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: '+t+'%)');
        if(sd.perf>sd.dept) st.push(s+' ØªÙÙˆÙ‚Øª Ø¹Ù„Ù‰ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù€ '+deptGap.toFixed(1)+'% (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: '+sd.dept.toFixed(1)+'%)');
        if(sd.perf>sd.kingdom) st.push(s+' ØªÙÙˆÙ‚Øª Ø¹Ù„Ù‰ Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø¨Ù€ '+kingGap.toFixed(1)+'% (Ø§Ù„Ù…Ù…Ù„ÙƒØ©: '+sd.kingdom.toFixed(1)+'%)');
        if(sd.perf>=70) st.push(s+' Ø­Ù‚Ù‚Øª Ù…Ø³ØªÙˆÙ‰ Ø£Ø¯Ø§Ø¡ Ù…ØªÙ…ÙŠØ² ('+sd.perf.toFixed(1)+'%)');
        
        // ØªØ­Ø³Ù† Ø¹Ù† Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        if(D.previousYear){
            var prev=getSD(f,s,D.previousYear);
            if(prev.perf>0){
                var ch=sd.perf-prev.perf;
                if(ch>5) st.push(s+' ØªØ­Ø³Ù†Øª Ø¨Ø´ÙƒÙ„ Ù…Ù„Ø­ÙˆØ¸ Ø¨Ù€ +'+ch.toFixed(1)+'% Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚');
                else if(ch>0) st.push(s+' Ø´Ù‡Ø¯Øª ØªØ­Ø³Ù†Ø§Ù‹ Ø·ÙÙŠÙØ§Ù‹ Ø¨Ù€ +'+ch.toFixed(1)+'% Ø¹Ù† Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚');
                if(ch<-5) wk.push(s+' ØªØ±Ø§Ø¬Ø¹Øª Ø¨Ø´ÙƒÙ„ Ù…Ù„Ø­ÙˆØ¸ Ø¨Ù€ '+ch.toFixed(1)+'% Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚');
                else if(ch<0) wk.push(s+' Ø´Ù‡Ø¯Øª ØªØ±Ø§Ø¬Ø¹Ø§Ù‹ Ø·ÙÙŠÙØ§Ù‹ Ø¨Ù€ '+ch.toFixed(1)+'% Ø¹Ù† Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚');
            }
        }
        
        // === Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù ===
        if(sd.perf<t){
            var g=(t-sd.perf).toFixed(1);
            wk.push(s+' Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ø¨Ù€ '+g+'% (Ø§Ù„ÙØ¹Ù„ÙŠ: '+sd.perf.toFixed(1)+'% / Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: '+t+'%)');
        }
        if(sd.perf<sd.dept) wk.push(s+' Ø£Ù‚Ù„ Ù…Ù† Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù€ '+Math.abs(deptGap).toFixed(1)+'%');
        if(sd.perf<sd.kingdom) wk.push(s+' Ø£Ù‚Ù„ Ù…Ù† Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø¨Ù€ '+Math.abs(kingGap).toFixed(1)+'%');
        if(sd.perf<30) wk.push(s+' ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø£Ø¯Ø§Ø¡ Ø­Ø±Ø¬ ÙˆÙŠØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„ Ø¹Ø§Ø¬Ù„ ('+sd.perf.toFixed(1)+'%)');
        
        // === Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø© ===
        if(sd.perf<t){
            if(s==='Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª'){
                rc.push('ØªÙƒØ«ÙŠÙ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ØªØ¯Ø±ÙŠØ³ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…Ø«Ù„: Ø§Ù„ØªØ¹Ù„Ù… Ø¨Ø§Ù„Ø§ÙƒØªØ´Ø§ÙØŒ Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø§ØªØŒ ÙˆØ§Ù„ØªØ¹Ù„Ù… Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠ');
                rc.push('ØªÙ†ÙˆÙŠØ¹ Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¨ØµØ±ÙŠØ© ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ù…Ø­Ø³ÙˆØ³Ø§Øª');
                rc.push('ØªØµÙ…ÙŠÙ… ØªØ¯Ø±ÙŠØ¨Ø§Øª Ù…ØªØ¯Ø±Ø¬Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ©');
            }else if(s==='Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©'){
                rc.push('ØªØ¹Ø²ÙŠØ² Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø®Ù„Ø§Ù„ Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙˆØ¬Ù‡Ø© ÙˆØ§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©');
                rc.push('ØªÙ†ÙˆÙŠØ¹ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ÙÙ‡Ù… Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ Ù…Ø«Ù„: Ø§Ù„ØªÙ„Ø®ÙŠØµØŒ ÙˆØ§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬ØŒ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ');
                rc.push('Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙƒØªØ¨Ø© ØµÙÙŠØ© ÙˆØªÙØ¹ÙŠÙ„ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ø·Ù„Ø§Ø¨');
            }else if(s==='Ø§Ù„Ø¹Ù„ÙˆÙ…'){
                rc.push('ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¬Ø§Ø±Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ù„Ù…Ø®ØªØ¨Ø±ÙŠØ© ÙÙŠ ØªØ¯Ø±ÙŠØ³ Ø§Ù„Ø¹Ù„ÙˆÙ… Ù„ØªØ¹Ø²ÙŠØ² Ø§Ù„ÙÙ‡Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠ');
                rc.push('Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ‚ØµØ§Ø¡ Ø§Ù„Ø¹Ù„Ù…ÙŠ ÙˆØ§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙÙŠ Ø§Ù„Ø¹Ù„ÙˆÙ…');
                rc.push('Ø±Ø¨Ø· Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø¹Ù„ÙˆÙ… Ø¨Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙˆØªÙˆØ¸ÙŠÙ Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠØ©');
            }
        }
    }
    
    // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©
    var doms={};for(var i=0;i<f.length;i++){var r=f[i],d=r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'];if(d!==r['Ø§Ù„Ù…Ø¬Ø§Ù„']){if(!doms[d])doms[d]={vals:[],subj:r['Ø§Ù„Ù…Ø¬Ø§Ù„']};doms[d].vals.push(r['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†']||0)}}
    var domAvgs=Object.entries(doms).map(function(e){return{name:e[0],subj:e[1].subj,avg:avg(e[1].vals)}}).sort(function(a,b){return b.avg-a.avg});
    
    if(domAvgs.length>0&&!isM){
        // Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª
        var topDoms=domAvgs.filter(function(d){return d.avg>=50});
        if(topDoms.length>0) st.push('Ù…Ø¬Ø§Ù„Ø§Øª Ù…ØªÙ…ÙŠØ²Ø©: '+topDoms.slice(0,3).map(function(d){return d.name+' ('+d.avg.toFixed(1)+'%)'}).join('ØŒ '));
        
        // Ø£Ø¶Ø¹Ù Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª
        var weakDoms=domAvgs.filter(function(d){return d.avg<40}).sort(function(a,b){return a.avg-b.avg});
        if(weakDoms.length>0){
            wk.push('Ù…Ø¬Ø§Ù„Ø§Øª ÙØ±Ø¹ÙŠØ© ØªØ­ØªØ§Ø¬ ØªØ¹Ø²ÙŠØ²: '+weakDoms.slice(0,3).map(function(d){return d.name+' ('+d.avg.toFixed(1)+'%)'}).join('ØŒ '));
            weakDoms.slice(0,2).forEach(function(d){
                rc.push('ØªØ®ØµÙŠØµ Ø­ØµØµ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¶Ø¹Ù ÙÙŠ Ù…Ø¬Ø§Ù„ Â«'+d.name+'Â» Ø¶Ù…Ù† Ù…Ø§Ø¯Ø© '+d.subj);
            });
        }
        
        // ÙØ¬ÙˆØ© ÙƒØ¨ÙŠØ±Ø© Ø¨ÙŠÙ† Ø£Ù‚ÙˆÙ‰ ÙˆØ£Ø¶Ø¹Ù Ù…Ø¬Ø§Ù„
        if(domAvgs.length>=2){
            var best=domAvgs[0],worst=domAvgs[domAvgs.length-1];
            if(best.avg-worst.avg>30) wk.push('ÙØ¬ÙˆØ© ÙƒØ¨ÙŠØ±Ø© ('+((best.avg-worst.avg).toFixed(1))+'%) Ø¨ÙŠÙ† Ø£Ù‚ÙˆÙ‰ Ù…Ø¬Ø§Ù„ Â«'+best.name+'Â» ÙˆØ£Ø¶Ø¹Ù Ù…Ø¬Ø§Ù„ Â«'+worst.name+'Â»');
        }
    }
    
    // ØªØ­Ù„ÙŠÙ„ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
    if(lvl.count>0){
        if(lvl.vl>30) wk.push('Ù†Ø³Ø¨Ø© Ù…Ø±ØªÙØ¹Ø© Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹ ('+lvl.vl.toFixed(1)+'%)');
        if(lvl.vl+lvl.l>50) wk.push('Ø£ÙƒØ«Ø± Ù…Ù† Ù†ØµÙ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© ('+(lvl.vl+lvl.l).toFixed(1)+'%)');
        if(lvl.h>30) st.push('Ù†Ø³Ø¨Ø© Ø¬ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø±ØªÙØ¹ ('+lvl.h.toFixed(1)+'%)');
        if(lvl.h+lvl.m>60) st.push('Ø£ØºÙ„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙŠØ§Øª Ø£Ø¯Ø§Ø¡ Ù…ØªÙˆØ³Ø·Ø© ÙˆÙ…Ø±ØªÙØ¹Ø© ('+(lvl.h+lvl.m).toFixed(1)+'%)');
        
        if(lvl.vl>20){
            rc.push('ØªØµÙ…ÙŠÙ… Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¹Ù„Ø§Ø¬ÙŠ Ù…ÙƒØ«Ù Ù„Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹ ('+lvl.vl.toFixed(1)+'%)');
            rc.push('ØªØ·Ø¨ÙŠÙ‚ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„ÙØ±Ø¯ÙŠ ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙØ§Ù‚Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ');
        }
    }
    
    // ØªÙˆØµÙŠØ§Øª Ø¹Ø§Ù…Ø© Ø¯Ø§Ø¦Ù…Ø©
    rc.push('ØªÙ†ÙˆÙŠØ¹ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³ ÙˆØªÙˆØ¸ÙŠÙ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù†Ø´Ø· ÙˆØ§Ù„ØªØ¹Ù„Ù… Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠ ÙˆØ§Ù„ØªØ¹Ù„Ù… Ø¨Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹');
    rc.push('ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ØªÙƒÙˆÙŠÙ†ÙŠ Ø§Ù„Ù…Ø³ØªÙ…Ø± Ù„Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù Ù…Ø¨ÙƒØ±Ø§Ù‹');
    rc.push('Ø¹Ù‚Ø¯ ÙˆØ±Ø´ Ø¹Ù…Ù„ ØªØ¯Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø­ÙˆÙ„ Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„ØªØ¯Ø±ÙŠØ³ Ø§Ù„Ø­Ø¯ÙŠØ«Ø© ÙˆÙ…Ø¹Ø§ÙŠÙŠØ± Ù†Ø§ÙØ³');
    rc.push('Ø¥Ø´Ø±Ø§Ùƒ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± ÙÙŠ Ø¯Ø¹Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø± ÙˆØ¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªÙˆØ¹ÙŠØ©');
    rc.push('ØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ø®Ø¨Ø±Ø§Øª ÙˆØ§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆÙ…Ø¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…ØªÙÙˆÙ‚Ø©');
    
    if(!st.length) st.push('ÙŠÙˆØ¬Ø¯ Ù…Ø¬Ø§Ù„ ÙˆØ§Ø³Ø¹ Ù„Ù„ØªØ­Ø³ÙŠÙ† ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ â€” ÙŠÙÙ†ØµØ­ Ø¨ÙˆØ¶Ø¹ Ø®Ø·Ø© ØªØ·ÙˆÙŠØ± Ø´Ø§Ù…Ù„Ø©');
    
    return{strengths:st,weaknesses:wk,recommendations:rc};
}

/* === MANUAL DOUGHNUT DRAWING (bypasses Chart.js hidden element bug) === */
function drawDoughnutManual(values,labels,colors,title){
    var size=600,cx=size/2,cy=240,radius=140,innerRadius=80;
    var c=document.createElement('canvas');c.width=size;c.height=size;
    var ctx=c.getContext('2d');
    // White background
    ctx.fillStyle='#ffffff';ctx.fillRect(0,0,size,size);
    // Title
    ctx.fillStyle='#333';ctx.font='bold 22px Tajawal, sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(title,cx,35);
    // Calculate total
    var total=0;for(var i=0;i<values.length;i++)total+=values[i];
    console.log('Doughnut values:',values,'total:',total);
    if(!total||total<=0||isNaN(total)){ctx.fillStyle='#999';ctx.font='18px Tajawal, sans-serif';ctx.fillText('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©',cx,cy);ctx.font='14px Tajawal, sans-serif';ctx.fillText('ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠØ­',cx,cy+30);return c.toDataURL('image/png',1.0)}
    // Draw slices
    var startAngle=-Math.PI/2;
    for(var i=0;i<values.length;i++){
        var sliceAngle=(values[i]/total)*2*Math.PI;
        ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,radius,startAngle,startAngle+sliceAngle);ctx.closePath();
        ctx.fillStyle=colors[i];ctx.fill();
        ctx.strokeStyle='#fff';ctx.lineWidth=3;ctx.stroke();
        // Draw percentage text on slice
        if(values[i]/total>0.05){
            var midAngle=startAngle+sliceAngle/2;
            var textR=radius*0.7;
            var tx=cx+Math.cos(midAngle)*textR;
            var ty=cy+Math.sin(midAngle)*textR;
            ctx.fillStyle='#fff';ctx.font='bold 16px Tajawal, sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.fillText((values[i]).toFixed(1)+'%',tx,ty);
        }
        startAngle+=sliceAngle;
    }
    // Inner circle (doughnut hole)
    ctx.beginPath();ctx.arc(cx,cy,innerRadius,0,2*Math.PI);ctx.fillStyle='#ffffff';ctx.fill();
    // Center text
    ctx.fillStyle='#4472C4';ctx.font='bold 20px Tajawal, sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('Ø§Ù„Ø£Ø¯Ø§Ø¡',cx,cy-10);
    ctx.fillStyle='#666';ctx.font='14px Tajawal, sans-serif';
    ctx.fillText('ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨',cx,cy+15);
    // Legend at bottom
    var legendY=cy+radius+40;var legendX=cx;var spacing=130;var startX=legendX-((labels.length-1)*spacing)/2;
    for(var i=0;i<labels.length;i++){
        var lx=startX+i*spacing;
        // Color circle
        ctx.beginPath();ctx.arc(lx-30,legendY,8,0,2*Math.PI);ctx.fillStyle=colors[i];ctx.fill();
        // Label text
        ctx.fillStyle='#333';ctx.font='14px Tajawal, sans-serif';ctx.textAlign='right';ctx.textBaseline='middle';
        ctx.fillText(labels[i]+' ('+values[i].toFixed(1)+'%)',lx+40,legendY);
    }
    return c.toDataURL('image/png',1.0);
}

/* === REPORT GENERATION (Tab 1) - Charts as IMAGES === */
async function generateReport(bd){
    if(!bd)bd=D.raw;
    var ld=bd.filter(function(r){return r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']===D.latestYear});
    var f=ld;if(D.subject!=='all')f=f.filter(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']===D.subject});
    var subjs=D.subject==='all'?['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','Ø§Ù„Ø¹Ù„ÙˆÙ…']:[D.subject];
    var tm={'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':D.targets.math,'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':D.targets.reading,'Ø§Ù„Ø¹Ù„ÙˆÙ…':D.targets.science};
    var ss=new Set();for(var i=0;i<bd.length;i++){var n=bd[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']||bd[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];if(n)ss.add(n)}
    var isM=ss.size>1;
    var an=analyze(f,subjs,tm,isM);

    // Build chart configs and render to images
    var sD=[],dD=[];for(var i=0;i<subjs.length;i++){var sd=getSD(f,subjs[i],D.latestYear);sD.push(sd.perf);dD.push(sd.dept)}
    var img1=await renderChartToImage({type:'bar',data:{labels:subjs,datasets:[{label:'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©',data:sD,backgroundColor:'#4472C4'},{label:'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',data:dD,backgroundColor:'#ffc107'}]},options:{plugins:{title:{display:true,text:'Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',font:{size:18}}},scales:{y:{beginAtZero:true,max:100}}}},800,400);

    var doms={};for(var i=0;i<f.length;i++){var r=f[i],d=r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'];if(d!==r['Ø§Ù„Ù…Ø¬Ø§Ù„']){if(!doms[d])doms[d]=[];doms[d].push(r['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†']||0)}}
    var lbl=Object.keys(doms),vals=lbl.map(function(l){return avg(doms[l])}),bgC=vals.map(function(v){return v>=60?'#28a745':v>=40?'#ffc107':'#dc3545'});
    var img2=await renderChartToImage({type:'bar',data:{labels:lbl,datasets:[{label:'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù†',data:vals,backgroundColor:bgC}]},options:{indexAxis:'y',plugins:{title:{display:true,text:'Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©',font:{size:18}}},scales:{x:{beginAtZero:true,max:100}}}},800,Math.max(350,lbl.length*50+100));

    // Levels doughnut chart - MANUAL DRAWING (Chart.js doughnut fails in hidden elements)
    // Use ld (all latest year data, not filtered by subject) for level distribution
    var lvlR=getLevels(ld);
    var img3=drawDoughnutManual([lvlR.h,lvlR.m,lvlR.l,lvlR.vl],['Ù…Ø±ØªÙØ¹','Ù…ØªÙˆØ³Ø·','Ù…Ù†Ø®ÙØ¶','Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹'],['#28a745','#36a2eb','#ffce56','#dc3545'],'ØªÙˆØ²ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡');

    // Trend chart
    var yrs=[...new Set(bd.map(function(r){return r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']}))].filter(Boolean).sort();
    var colors={'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':'#4472C4','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':'#28a745','Ø§Ù„Ø¹Ù„ÙˆÙ…':'#ffc107'},tds=[];
    for(var s=0;s<subjs.length;s++){var v=yrs.map(function(y){return getSD(bd,subjs[s],y).perf});tds.push({label:subjs[s],data:v,borderColor:colors[subjs[s]],backgroundColor:colors[subjs[s]]+'20',borderWidth:3,tension:.3,fill:true})}
    var img4=yrs.length>1?await renderChartToImage({type:'line',data:{labels:yrs,datasets:tds},options:{plugins:{title:{display:true,text:'ØªØ·ÙˆØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ø¨Ø± Ø§Ù„Ø³Ù†ÙˆØ§Øª',font:{size:18}}},scales:{y:{beginAtZero:true,max:100}}}},800,400):null;

    // Build report HTML with IMG tags only
    var html='<div id="reportForPDF">';
    html+='<div class="report-section"><div class="report-header"><h1>'+D.school+'</h1><h2>ØªÙ‚Ø±ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ù†Ø§ÙØ³ Ø§Ù„ÙˆØ·Ù†ÙŠØ©</h2><h3>Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: '+D.latestYear+'</h3></div>';
    html+='<div class="report-stats">';
    for(var i=0;i<subjs.length;i++){var sd=getSD(bd,subjs[i],D.latestYear);if(sd.perf>0||sd.isMulti)html+='<div class="report-stat"><h3>'+subjs[i]+'</h3><h2 style="color:#4472C4;font-size:2.5em">'+sd.perf.toFixed(1)+'%</h2><p>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: '+tm[subjs[i]]+'%</p></div>'}
    html+='</div></div>';
    html+='<div class="report-section"><div class="strengths-box"><h3>âœ… Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©</h3><ul>';for(var i=0;i<an.strengths.length;i++)html+='<li>'+an.strengths[i]+'</li>';html+='</ul></div></div>';
    html+='<div class="report-section"><div class="weaknesses-box"><h3>âš ï¸ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù</h3><ul>';for(var i=0;i<an.weaknesses.length;i++)html+='<li>'+an.weaknesses[i]+'</li>';html+='</ul></div></div>';
    html+='<div class="report-section"><div class="recommendations-box"><h3>ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ§Øª</h3><ol>';for(var i=0;i<an.recommendations.length;i++)html+='<li>'+an.recommendations[i]+'</li>';html+='</ol></div></div>';
    // Charts as images
    html+='<div class="report-section"><h3 style="color:#4472C4;text-align:center;margin-bottom:20px">ğŸ“Š Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</h3>';
    if(img1)html+='<div style="background:#f9f9f9;border-radius:10px;padding:15px;margin:15px 0;text-align:center"><img class="report-chart-img" src="'+img1+'" alt="chart1"></div>';
    if(img2)html+='<div style="background:#f9f9f9;border-radius:10px;padding:15px;margin:15px 0;text-align:center"><img class="report-chart-img" src="'+img2+'" alt="chart2"></div>';
    if(img3)html+='<div style="background:#f9f9f9;border-radius:10px;padding:15px;margin:15px 0;text-align:center"><img class="report-chart-img" src="'+img3+'" alt="chart3" style="max-width:500px"></div>';
    if(img4)html+='<div style="background:#f9f9f9;border-radius:10px;padding:15px;margin:15px 0;text-align:center"><img class="report-chart-img" src="'+img4+'" alt="chart4"></div>';
    html+='</div></div>';
    document.getElementById('reportPreview').innerHTML=html;
}

/* === SCHOOL RANKING (Tab 2) === */
function generateRanking(bd){
    if(!bd)bd=D.raw;
    var ss=new Set();for(var i=0;i<bd.length;i++){var n=bd[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']||bd[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];if(n)ss.add(n)}
    if(ss.size<2){document.getElementById('rankingContent').innerHTML='<div class="alert alert-warning" style="text-align:center;font-size:1.2em">âš ï¸ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙŠØªØ·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ø­Ø¯Ø©</div>';return}
    
    // Use ranking-specific subject, default to global or 'all'
    if(!D.rankSubject)D.rankSubject='all';
    var subj=D.rankSubject==='all'?null:D.rankSubject;
    var subjLabel=subj||'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯';
    
    function getSchoolPerf(schoolName,year){
        var rows=bd.filter(function(r){return(r['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']===schoolName||r['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']===schoolName)&&r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']===year});
        if(subj)rows=rows.filter(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']===subj});
        var mainRows=rows.filter(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']===r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ']});
        if(!mainRows.length)mainRows=rows;
        var totalTested=0,totalPassed=0;
        for(var i=0;i<mainRows.length;i++){totalTested+=mainRows[i]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†']||0;totalPassed+=mainRows[i]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†']||0}
        return totalTested>0?(totalPassed/totalTested)*100:0;
    }
    
    var schools=[];
    ss.forEach(function(name){
        var perf=getSchoolPerf(name,D.latestYear);
        var prevPerf=D.previousYear?getSchoolPerf(name,D.previousYear):null;
        var change=prevPerf!==null&&prevPerf>0?(perf-prevPerf):null;
        if(perf>0)schools.push({name:name,perf:perf,prevPerf:prevPerf,change:change});
    });
    
    var sorted=[].concat(schools).sort(function(a,b){return b.perf-a.perf});
    var top20=sorted.slice(0,20);
    var bottom20=[].concat(schools).sort(function(a,b){return a.perf-b.perf}).slice(0,20);
    var withChange=schools.filter(function(s){return s.change!==null});
    var improved=[].concat(withChange).sort(function(a,b){return b.change-a.change}).slice(0,20).filter(function(s){return s.change>0});
    var declined=[].concat(withChange).sort(function(a,b){return a.change-b.change}).slice(0,20).filter(function(s){return s.change<0});
    
    function rankClass(i){return i===0?'gold':i===1?'silver':i===2?'bronze':'normal'}
    function scoreClass(v){return v>=50?'high':v>=30?'mid':'low'}
    function changeHtml(c){
        if(c===null)return'<span class="rank-change same">-</span>';
        if(c>0)return'<span class="rank-change up"><span class="change-arrow">â–²</span>+'+c.toFixed(1)+'%</span>';
        if(c<0)return'<span class="rank-change down"><span class="change-arrow">â–¼</span>'+c.toFixed(1)+'%</span>';
        return'<span class="rank-change same"><span class="change-arrow">â—</span>0%</span>';
    }
    function buildList(items,type){
        var html='<ul class="ranking-list">';
        for(var i=0;i<items.length;i++){
            var s=items[i];var nc=type==='bottom'?'bad':rankClass(i);
            var rank=type==='bottom'?'':('#'+(sorted.indexOf(s)+1)+' Ù…Ù† '+schools.length);
            html+='<li class="ranking-item">';
            html+='<div class="rank-num '+nc+'">'+(i+1)+'</div>';
            html+='<div class="rank-info"><div class="rank-name">'+s.name+'</div>';
            if(s.prevPerf!==null&&s.prevPerf>0)html+='<div class="rank-detail">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: '+s.prevPerf.toFixed(1)+'%</div>';
            html+='</div>';
            html+=changeHtml(s.change);
            html+='<div class="rank-score '+scoreClass(s.perf)+'">'+s.perf.toFixed(1)+'%</div>';
            html+='</li>';
        }
        html+='</ul>';return html;
    }
    
    // === BUILD HTML ===
    var html='<div class="ranking-header"><h2>ğŸ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</h2>';
    html+='<p>Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: '+D.latestYear+' | Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: '+schools.length+'</p></div>';
    
    // Subject filter tabs
    var allSubjs=['all','Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','Ø§Ù„Ø¹Ù„ÙˆÙ…'];
    var allLabels={'all':'ğŸ“Š Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯','Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':'ğŸ“ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':'ğŸ“– Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','Ø§Ù„Ø¹Ù„ÙˆÙ…':'ğŸ”¬ Ø§Ù„Ø¹Ù„ÙˆÙ…'};
    html+='<div class="ranking-subj-tabs">';
    for(var i=0;i<allSubjs.length;i++){
        var k=allSubjs[i];
        html+='<button class="ranking-subj-btn'+(D.rankSubject===k?' active':'')+'" onclick="setRankSubject(\''+k+'\')">'+allLabels[k]+'</button>';
    }
    html+='</div>';
    
    // School search within ranking
    html+='<div style="max-width:500px;margin:0 auto 25px;position:relative">';
    html+='<input type="text" id="rankSchoolSearch" class="search-select-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³Ø© Ù„Ù…Ø¹Ø±ÙØ© ØªØ±ØªÙŠØ¨Ù‡Ø§..." oninput="searchSchoolRank()" style="text-align:center">';
    html+='<div id="rankSearchResult" style="display:none"></div>';
    html+='</div>';
    
    // Showing subject label
    html+='<div style="text-align:center;margin-bottom:20px"><span style="background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;padding:8px 25px;border-radius:20px;font-weight:700;font-size:1.1em">'+subjLabel+'</span></div>';
    
    // Top & Bottom
    html+='<div class="ranking-grid">';
    html+='<div class="ranking-card"><div class="ranking-card-header top">ğŸ¥‡ Ø£ÙØ¶Ù„ 20 Ù…Ø¯Ø±Ø³Ø©</div>'+buildList(top20,'top')+'</div>';
    html+='<div class="ranking-card"><div class="ranking-card-header bottom">âš ï¸ Ø£Ù‚Ù„ 20 Ù…Ø¯Ø±Ø³Ø©</div>'+buildList(bottom20,'bottom')+'</div>';
    html+='</div>';
    
    // Improved & Declined
    if(improved.length>0||declined.length>0){
        html+='<div style="margin-top:35px"><h2 style="color:#4472C4;text-align:center;margin-bottom:25px">ğŸ“ˆ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚ ('+D.previousYear+')</h2></div>';
        html+='<div class="ranking-grid">';
        if(improved.length>0)html+='<div class="ranking-card"><div class="ranking-card-header improved">ğŸ“ˆ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ØªØ­Ø³Ù†Ø§Ù‹ ('+improved.length+')</div>'+buildList(improved,'top')+'</div>';
        if(declined.length>0)html+='<div class="ranking-card"><div class="ranking-card-header declined">ğŸ“‰ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ØªØ±Ø§Ø¬Ø¹Ø§Ù‹ ('+declined.length+')</div>'+buildList(declined,'bottom')+'</div>';
        html+='</div>';
    }
    
    // Summary stats
    var avgPerf=avg(schools.map(function(s){return s.perf}));
    var above50=schools.filter(function(s){return s.perf>=50}).length;
    var below30=schools.filter(function(s){return s.perf<30}).length;
    html+='<div style="margin-top:35px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;text-align:center">';
    html+='<div style="background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;padding:25px;border-radius:12px"><div style="font-size:2.2em;font-weight:900">'+avgPerf.toFixed(1)+'%</div><div style="margin-top:8px;opacity:.9">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…</div></div>';
    html+='<div style="background:linear-gradient(135deg,#28a745,#20c997);color:#fff;padding:25px;border-radius:12px"><div style="font-size:2.2em;font-weight:900">'+above50+'</div><div style="margin-top:8px;opacity:.9">Ù…Ø¯Ø±Ø³Ø© ÙÙˆÙ‚ 50%</div></div>';
    html+='<div style="background:linear-gradient(135deg,#dc3545,#c82333);color:#fff;padding:25px;border-radius:12px"><div style="font-size:2.2em;font-weight:900">'+below30+'</div><div style="margin-top:8px;opacity:.9">Ù…Ø¯Ø±Ø³Ø© Ø£Ù‚Ù„ Ù…Ù† 30%</div></div>';
    if(improved.length>0)html+='<div style="background:linear-gradient(135deg,#17a2b8,#138496);color:#fff;padding:25px;border-radius:12px"><div style="font-size:2.2em;font-weight:900">'+improved.length+'</div><div style="margin-top:8px;opacity:.9">Ù…Ø¯Ø±Ø³Ø© ØªØ­Ø³Ù†Øª</div></div>';
    html+='</div>';
    
    document.getElementById('rankingContent').innerHTML=html;
    
    // Store sorted data for search
    D._rankSorted=sorted;
    D._rankSchools=schools;
}

function setRankSubject(s){
    D.rankSubject=s;
    generateRanking(D.raw);
}

function searchSchoolRank(){
    var q=document.getElementById('rankSchoolSearch').value.trim();
    var res=document.getElementById('rankSearchResult');
    if(!q||!D._rankSorted){res.style.display='none';return}
    
    var matches=D._rankSorted.filter(function(s){return s.name.indexOf(q)!==-1});
    if(!matches.length){
        res.style.display='block';
        res.innerHTML='<div style="background:#f8d7da;color:#721c24;padding:15px;border-radius:10px;margin-top:10px;text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ "'+q+'"</div>';
        return;
    }
    
    var total=D._rankSorted.length;
    var html='<div style="margin-top:10px">';
    for(var i=0;i<Math.min(matches.length,5);i++){
        var s=matches[i];
        var rank=D._rankSorted.indexOf(s)+1;
        var pct=((rank/total)*100).toFixed(0);
        var color=s.perf>=50?'#28a745':s.perf>=30?'#ffc107':'#dc3545';
        var changeStr=s.change!==null?(s.change>0?'<span style="color:#28a745;font-weight:700"> â–²+'+s.change.toFixed(1)+'%</span>':'<span style="color:#dc3545;font-weight:700"> â–¼'+s.change.toFixed(1)+'%</span>'):'';
        html+='<div style="background:#fff;border:2px solid '+color+';border-radius:12px;padding:18px;margin-bottom:10px;display:flex;align-items:center;gap:15px;flex-wrap:wrap">';
        html+='<div style="background:'+color+';color:#fff;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1.2em;flex-shrink:0">'+rank+'</div>';
        html+='<div style="flex:1;min-width:150px"><div style="font-weight:700;font-size:1.1em">'+s.name+'</div><div style="color:#888;font-size:.9em;margin-top:3px">Ø§Ù„ØªØ±ØªÙŠØ¨ '+rank+' Ù…Ù† '+total+' (Ø£Ø¹Ù„Ù‰ Ù…Ù† '+Math.max(0,100-parseInt(pct))+'% Ù…Ù† Ø§Ù„Ù…Ø¯Ø§Ø±Ø³)</div></div>';
        html+='<div style="text-align:center;flex-shrink:0"><div style="font-size:1.8em;font-weight:900;color:'+color+'">'+s.perf.toFixed(1)+'%</div>'+changeStr+'</div>';
        html+='</div>';
    }
    if(matches.length>5)html+='<div style="text-align:center;color:#888;padding:10px">ÙˆØ£ÙŠØ¶Ø§Ù‹ '+(matches.length-5)+' Ù…Ø¯Ø±Ø³Ø© Ø£Ø®Ø±Ù‰...</div>';
    html+='</div>';
    res.style.display='block';
    res.innerHTML=html;
}

/* === PDF EXPORT - Section by section to prevent cutting === */
async function exportPDF(){
    var el=document.getElementById('reportForPDF');
    if(!el){alert('âš ï¸ Ø§Ù†ØªÙ‚Ù„ Ù„ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„" Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª');return}

    var ov=document.createElement('div');
    ov.className='pdf-overlay';
    ov.innerHTML='<div class="pdf-overlay-content"><h3>ğŸ“„ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF</h3><p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</p><div class="pdf-progress"><div class="pdf-progress-bar"></div></div></div>';
    document.body.appendChild(ov);

    try{
        // Wait for all images
        var imgs=el.querySelectorAll('img');
        await Promise.all(Array.from(imgs).map(function(img){
            return new Promise(function(r){if(img.complete)r();else{img.onload=r;img.onerror=r}});
        }));

        var pdf=new jspdf.jsPDF('p','mm','a4');
        var pw=pdf.internal.pageSize.getWidth();
        var ph=pdf.internal.pageSize.getHeight();
        var margin=10;
        var uw=pw-margin*2; // usable width
        var uh=ph-margin*2; // usable height
        var curY=margin;

        // Helper: capture a DOM element to image and get its dimensions in mm
        async function captureElement(elem){
            var canvas=await html2canvas(elem,{
                scale:2,useCORS:true,allowTaint:true,backgroundColor:'#ffffff',
                logging:false,scrollX:0,scrollY:0
            });
            var imgData=canvas.toDataURL('image/jpeg',0.95);
            var ratio=canvas.width/canvas.height;
            var imgW=uw;
            var imgH=imgW/ratio;
            return{data:imgData,w:imgW,h:imgH};
        }

        // Helper: add image to PDF, handle page breaks
        function addToPDF(imgObj){
            if(curY+imgObj.h>ph-margin){
                pdf.addPage();
                curY=margin;
            }
            pdf.addImage(imgObj.data,'JPEG',margin,curY,imgObj.w,imgObj.h);
            curY+=imgObj.h+3;
        }

        // Get all report sections
        var sections=el.querySelectorAll('.report-section');
        
        if(sections.length>0){
            for(var i=0;i<sections.length;i++){
                var sec=sections[i];
                // Check if section has sub-elements that should be split further
                var children=sec.children;
                var hasLargeContent=sec.scrollHeight>800;
                
                if(hasLargeContent && children.length>1){
                    // Capture each child separately to avoid large sections being cut
                    for(var j=0;j<children.length;j++){
                        var child=children[j];
                        if(child.scrollHeight>10){
                            var img=await captureElement(child);
                            // If single child is too tall for one page, scale it down
                            if(img.h>uh){
                                var scale=uh/img.h;
                                img.w*=scale;
                                img.h=uh;
                            }
                            addToPDF(img);
                        }
                    }
                }else{
                    var img=await captureElement(sec);
                    // If section is too tall, scale down
                    if(img.h>uh){
                        var scale=uh/img.h;
                        img.w*=scale;
                        img.h=uh;
                    }
                    addToPDF(img);
                }
            }
        }else{
            // Fallback: capture entire report
            var img=await captureElement(el);
            addToPDF(img);
        }

        pdf.save('ØªÙ‚Ø±ÙŠØ±_Ù†Ø§ÙØ³.pdf');
    }catch(err){
        console.error('PDF Error:',err);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: '+err.message);
    }finally{
        if(ov.parentNode)ov.parentNode.removeChild(ov);
    }
}

/* === PRINT === */
function printReport(){
    var el=document.getElementById('reportForPDF');
    if(!el){alert('âš ï¸ Ø§Ù†ØªÙ‚Ù„ Ù„ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„" Ø£ÙˆÙ„Ø§Ù‹');return}
    var pw=window.open('','_blank');
    if(!pw){alert('âš ï¸ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©');return}
    pw.document.write('<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>ØªÙ‚Ø±ÙŠØ± Ù†Ø§ÙØ³</title><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Tajawal,sans-serif;padding:20px;background:#fff;direction:rtl}.pc{max-width:800px;margin:0 auto;padding:20px}.pa{position:fixed;top:20px;left:20px;background:#fff;padding:15px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;display:flex;gap:10px}.pa button{background:#4472C4;color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-family:Tajawal,sans-serif}.pa .bp{background:#dc3545}.report-header{text-align:center;padding:30px;background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;border-radius:10px;margin-bottom:30px;-webkit-print-color-adjust:exact;print-color-adjust:exact}.report-stats{display:flex;justify-content:space-around;margin:30px 0;gap:15px}.report-stat{text-align:center;padding:20px;background:#f8f9fa;border-radius:10px;flex:1;border:2px solid #e0e0e0}.report-stat h2{color:#4472C4;font-size:2.5em}.strengths-box,.weaknesses-box,.recommendations-box{margin:20px 0;padding:20px;border-radius:10px;-webkit-print-color-adjust:exact;print-color-adjust:exact}.strengths-box{background:#d4edda;border:2px solid #28a745}.strengths-box h3{color:#155724;margin-bottom:15px}.weaknesses-box{background:#f8d7da;border:2px solid #dc3545}.weaknesses-box h3{color:#721c24;margin-bottom:15px}.recommendations-box{background:#fff3cd;border:2px solid #ffc107}.recommendations-box h3{color:#856404;margin-bottom:15px}ul{list-style:none;padding:0}li{padding:8px 0;border-bottom:1px solid rgba(0,0,0,.1)}ol{padding-right:25px}img{max-width:100%;height:auto;display:block;margin:10px auto}.report-section{page-break-inside:avoid;margin-bottom:20px}.report-chart-img{width:100%;max-width:700px;height:auto;display:block;margin:10px auto}@media print{.pa{display:none}.report-header,.strengths-box,.weaknesses-box,.recommendations-box,.report-stat{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}}</style></head><body><div class="pa"><button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button onclick="window.close()">âŒ Ø¥ØºÙ„Ø§Ù‚</button></div><div class="pc">'+el.innerHTML+'</div></body></html>');
    pw.document.close();
}
</script>
</body>
</html>
