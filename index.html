<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ù†Ø§ÙØ³ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Tajawal','Segoe UI',Tahoma,sans-serif;background:linear-gradient(135deg,#4472C4,#764ba2);min-height:100vh;padding:20px}
        .container{max-width:1400px;margin:0 auto}
        .header{text-align:center;background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;padding:40px;border-radius:15px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
        .header h1{font-size:2.5em;margin-bottom:10px}
        .card{background:#fff;border-radius:15px;padding:30px;margin-bottom:20px;box-shadow:0 10px 40px rgba(0,0,0,.1)}
        .targets-section{background:#f0f4ff;border:2px solid #4472C4;border-radius:12px;padding:25px}
        .targets-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-top:20px}
        .target-input{background:#fff;padding:20px;border-radius:10px;border:2px solid #e0e0e0}
        .target-input h4{color:#4472C4;margin-bottom:15px}
        .target-input label{display:block;margin-bottom:8px;font-weight:700;color:#333}
        .target-input input{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1.1em;font-family:'Tajawal',sans-serif}
        .upload-area{border:3px dashed #4472C4;border-radius:12px;padding:50px;text-align:center;cursor:pointer;transition:.3s;background:rgba(68,114,196,.05)}
        .upload-area:hover,.upload-area.dragover{background:rgba(68,114,196,.15);transform:scale(1.02)}
        .upload-icon{font-size:5em;margin-bottom:20px}
        .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:20px 0}
        .stat-card{color:#fff;padding:25px;border-radius:12px;text-align:center;box-shadow:0 5px 20px rgba(0,0,0,.1);transition:.3s}
        .stat-card:hover{transform:translateY(-5px)}
        .stat-card.improved{background:linear-gradient(135deg,#28a745,#20c997)}
        .stat-card.declined{background:linear-gradient(135deg,#dc3545,#c82333)}
        .stat-card.neutral{background:linear-gradient(135deg,#ffc107,#e0a800)}
        .stat-card h3{font-size:2.5em;margin-bottom:5px}
        .stat-card .comparison{font-size:.85em;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.3)}
        .stat-card .trend{font-size:.9em;margin-top:5px;font-weight:700}
        .comparison-table{width:100%;margin:20px 0;border-collapse:collapse}
        .comparison-table th,.comparison-table td{padding:15px;text-align:center;border:2px solid #e0e0e0}
        .comparison-table th{background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;font-weight:700}
        .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0}
        .form-group label{display:block;margin-bottom:10px;font-weight:700;color:#333}
        .form-group select{width:100%;padding:15px;border:2px solid #e0e0e0;border-radius:8px;font-size:1.1em;font-family:'Tajawal',sans-serif}
        .btn{padding:15px 40px;background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;border:none;border-radius:10px;font-size:1.1em;font-weight:700;cursor:pointer;margin:10px 5px;transition:.3s;font-family:'Tajawal',sans-serif}
        .btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(68,114,196,.4)}
        .btn-success{background:linear-gradient(135deg,#28a745,#20c997)}
        .btn-pdf{background:linear-gradient(135deg,#dc3545,#c82333)}
        .chart-container{position:relative;height:400px;margin:30px 0;padding:25px;background:#f9f9f9;border-radius:10px}
        .tabs{display:flex;gap:10px;margin-bottom:25px;flex-wrap:wrap}
        .tab{padding:15px 30px;background:#f0f0f0;border:none;border-radius:10px;cursor:pointer;font-size:1.1em;font-weight:700;transition:.3s;font-family:'Tajawal',sans-serif}
        .tab.active{background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff}
        .tab-content{display:none}.tab-content.active{display:block}
        .report-section{page-break-inside:avoid;margin-bottom:30px}
        .report-header{text-align:center;padding:30px;background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;border-radius:10px;margin-bottom:30px}
        .report-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin:20px 0}
        .report-stat{background:#f8f9fa;padding:15px;border-radius:8px;text-align:center;border:2px solid #e0e0e0}
        .strengths-box{background:#d4edda;border:2px solid #28a745;border-radius:10px;padding:20px;margin:20px 0}
        .strengths-box h3{color:#155724;margin-bottom:15px}
        .strengths-box ul{list-style:none;padding:0}
        .strengths-box li{padding:10px 0;border-bottom:1px solid #c3e6cb}
        .strengths-box li:before{content:"âœ… ";margin-left:10px}
        .weaknesses-box{background:#f8d7da;border:2px solid #dc3545;border-radius:10px;padding:20px;margin:20px 0}
        .weaknesses-box h3{color:#721c24;margin-bottom:15px}
        .weaknesses-box ul{list-style:none;padding:0}
        .weaknesses-box li{padding:10px 0;border-bottom:1px solid #f5c6cb}
        .weaknesses-box li:before{content:"âš ï¸ ";margin-left:10px}
        .recommendations-box{background:#fff3cd;border:2px solid #ffc107;border-radius:10px;padding:20px;margin:20px 0}
        .recommendations-box h3{color:#856404;margin-bottom:15px}
        .recommendations-box ol{padding-right:20px}
        .recommendations-box li{padding:10px 0;border-bottom:1px solid #ffeaa7}
        .alert{padding:20px;border-radius:10px;margin:20px 0;font-size:1.1em}
        .alert-info{background:#d1ecf1;border:2px solid #bee5eb;color:#0c5460}
        .alert-success{background:#d4edda;border:2px solid #c3e6cb;color:#155724}
        .alert-warning{background:#fff3cd;border:2px solid #ffc107;color:#856404}
        .spinner{border:5px solid rgba(255,255,255,.3);border-top:5px solid #4472C4;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin:30px auto;display:none}
        .spinner.show{display:block}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .hidden{display:none!important}
        .pdf-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:9999}
        .pdf-overlay-content{background:#fff;border-radius:15px;padding:40px;text-align:center;max-width:400px}
        .pdf-overlay-content h3{color:#4472C4;margin-bottom:15px}
        .pdf-progress{width:100%;height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden;margin-top:15px}
        .pdf-progress-bar{height:100%;background:linear-gradient(135deg,#4472C4,#764ba2);border-radius:4px;animation:prog 2s ease-in-out infinite;width:60%}
        @keyframes prog{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}
        #chartFactory{position:absolute;left:-99999px;top:0;pointer-events:none;overflow:hidden}
        @media print{@page{size:A4;margin:10mm}body{background:#fff!important;padding:0!important;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}.no-print{display:none!important}#tab0{display:none!important}#tab1{display:block!important}#mainCard{display:block!important;visibility:visible!important}.report-header,.strengths-box,.weaknesses-box,.recommendations-box,.report-stat{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}.report-stats{display:flex!important;gap:10px}.report-section{page-break-inside:avoid}}
        @media(max-width:768px){.header h1{font-size:1.8em}.dashboard,.targets-grid,.report-stats{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div id="chartFactory"></div>
<div class="container">
    <div class="header no-print"><h1>ğŸ“Š Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ù†Ø§ÙØ³ Ø§Ù„ÙˆØ·Ù†ÙŠØ©</h1><p style="font-size:1.2em">Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù…Ø¹ ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ ÙˆÙ†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„Ø¶Ø¹Ù</p><div id="quickActions" style="display:none;margin-top:20px"><button class="btn" onclick="document.getElementById('targetsCard').style.display='block';document.getElementById('targetsCard').scrollIntoView({behavior:'smooth'})">âš™ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª</button> <button class="btn" onclick="showUploadArea();document.getElementById('uploadCard').scrollIntoView({behavior:'smooth'})">ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù Excel Ø¬Ø¯ÙŠØ¯</button></div></div>
    <div class="card no-print" id="targetsCard"><div class="targets-section"><h2 style="color:#4472C4;margin-bottom:20px">ğŸ¯ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø©</h2><p style="margin-bottom:20px;color:#666">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø©</p><div class="targets-grid"><div class="target-input"><h4>ğŸ“ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</h4><label>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (%)</label><input type="number" id="targetMath" value="50" min="0" max="100"></div><div class="target-input"><h4>ğŸ“– Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</h4><label>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (%)</label><input type="number" id="targetReading" value="55" min="0" max="100"></div><div class="target-input"><h4>ğŸ”¬ Ø§Ù„Ø¹Ù„ÙˆÙ…</h4><label>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (%)</label><input type="number" id="targetScience" value="60" min="0" max="100"></div></div><div style="text-align:center;margin-top:20px"><button class="btn btn-success" onclick="saveTargets()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª</button></div></div></div>
    <div class="card no-print" id="uploadCard" style="display:none"><h2 style="color:#4472C4;margin-bottom:25px;text-align:center">ğŸ“ Ø§Ø±ÙØ¹ Ù…Ù„Ù Ù†Ø§ÙØ³</h2><div class="alert alert-info"><strong>ğŸ’¡</strong> Ø§Ø±ÙØ¹ Ù…Ù„Ù Ù†Ø§ÙØ³ Ø§Ù„Ø±Ø³Ù…ÙŠ (.xlsx)</div><div class="upload-area" id="uploadArea"><div class="upload-icon">ğŸ“¤</div><h2>Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ù‡Ù†Ø§</h2><p style="font-size:1.2em;margin:15px 0">Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p><input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none"></div><div class="spinner" id="spinner"></div><div id="status"></div></div>
    <div class="card hidden no-print" id="dashboardCard"><h2 style="color:#4472C4;margin-bottom:20px">ğŸ“ˆ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… <span id="currentYear"></span></h2><div class="dashboard" id="stats"></div></div>
    <div class="card hidden no-print" id="comparisonCard"><h2 style="color:#4472C4;margin-bottom:20px">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</h2><div id="comparisonTableContainer"></div></div>
    <div class="card hidden no-print" id="controlsCard"><h2 style="color:#4472C4;margin-bottom:20px">âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶</h2><div class="controls"><div class="form-group"><label>ğŸ“š Ø§Ù„Ù…Ø§Ø¯Ø©</label><select id="subjectSelect" onchange="updateView()"><option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option></select></div><div class="form-group"><label>ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><select id="schoolSelect" onchange="updateView()"><option value="">Ø§Ù„ÙƒÙ„</option></select></div></div></div>
    <div class="card hidden" id="mainCard">
        <div class="tabs no-print"><button class="tab active" onclick="switchTab(0)">ğŸ“Š Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª</button><button class="tab" onclick="switchTab(1)">ğŸ“„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„</button></div>
        <div class="tab-content active" id="tab0"><div id="chartsContent"></div></div>
        <div class="tab-content" id="tab1"><div id="reportPreview"></div><div style="text-align:center;margin-top:30px" class="no-print"><button class="btn btn-pdf" onclick="exportPDF()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF</button> <button class="btn" onclick="printReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div></div>
    </div>
</div>
<script>
var D={raw:[],school:'',subject:'all',latestYear:'',previousYear:'',charts:{},targets:{math:50,reading:55,science:60}};
function avg(a){if(!a||!a.length)return 0;var s=0;for(var i=0;i<a.length;i++)s+=a[i];return s/a.length}
function getSD(bd,subj,yr){var ld=bd.filter(function(r){return r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']===yr});var ss=new Set();for(var i=0;i<bd.length;i++){var n=bd[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']||bd[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];if(n)ss.add(n)}var m=ss.size>1,p=0,d=0,k=0;if(m){var sd=ld.filter(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']===subj&&r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ']===subj});var ts=0,tp=0,sD=0,sK=0,c=0;for(var j=0;j<sd.length;j++){ts+=sd[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†']||0;tp+=sd[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†']||0;sD+=sd[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…']||0;sK+=sd[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©']||0;c++}if(ts>0){p=(tp/ts)*100;d=c>0?sD/c:0;k=c>0?sK/c:0}}else{var cur=ld.find(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']===subj&&r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ']===subj});if(cur){p=cur['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†']||0;d=cur['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…']||0;k=cur['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©']||0}}return{perf:p,dept:d,kingdom:k,isMulti:m,sc:ss.size}}
function showStatus(m,t){var d=document.getElementById('status');if(!d)return;d.innerHTML='<div class="alert alert-'+t+'">'+m+'</div>';setTimeout(function(){d.innerHTML=''},5000)}
function switchTab(i){var t=document.querySelectorAll('.tab'),c=document.querySelectorAll('.tab-content');for(var j=0;j<t.length;j++){t[j].classList.toggle('active',j===i);c[j].classList.toggle('active',j===i)}}

/* === CHART TO IMAGE === */
function renderChartToImage(cfg,w,h){return new Promise(function(resolve){var f=document.getElementById('chartFactory');var c=document.createElement('canvas');c.width=w||800;c.height=h||400;f.appendChild(c);cfg.options=cfg.options||{};cfg.options.animation=false;cfg.options.responsive=false;cfg.options.maintainAspectRatio=false;var ch=new Chart(c,cfg);setTimeout(function(){var img='';try{img=c.toDataURL('image/png',1.0)}catch(e){}ch.destroy();f.removeChild(c);resolve(img)},500)})}

/* === INIT === */
document.addEventListener('DOMContentLoaded',function(){loadTargets();setupFileUpload();autoLoadData()});
function autoLoadData(){showStatus('â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...','info');tryLoad(['nafes-data.json','data.json'],0)}
function tryLoad(s,i){if(i>=s.length){showStatus('','info');document.getElementById('targetsCard').style.display='none';document.getElementById('uploadCard').style.display='block';var uc=document.getElementById('uploadCard');uc.innerHTML='<h2 style="color:#4472C4;margin-bottom:25px;text-align:center">ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù Excel</h2><div class="upload-area" id="uploadArea"><div class="upload-icon">ğŸ“¤</div><h2>Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ù‡Ù†Ø§</h2><p style="font-size:1.2em;margin:15px 0">Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p><input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none"></div><div class="spinner" id="spinner"></div><div id="status"></div>';setupFileUpload();return}fetch(s[i]).then(function(r){if(!r.ok)throw 0;return r.json()}).then(function(rows){if(!rows||!rows.length)throw 0;loadData(rows)}).catch(function(){tryLoad(s,i+1)})}
function loadData(rows){D.raw=rows;var ss=new Set();for(var i=0;i<rows.length;i++){var n=rows[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']||rows[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];if(n)ss.add(n)}var sc=ss.size;D.school=sc===1?Array.from(ss)[0]:sc>1?'Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ('+sc+' Ù…Ø¯Ø±Ø³Ø©)':'Ù†Ø§ÙØ³';var yrs=[...new Set(rows.map(function(r){return r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']}))].filter(Boolean).sort();D.latestYear=yrs[yrs.length-1];D.previousYear=yrs.length>1?yrs[yrs.length-2]:null;populateSelects();populateSchools();showDashboard();showComparison();document.getElementById('controlsCard').classList.remove('hidden');document.getElementById('mainCard').classList.remove('hidden');updateView();document.getElementById('targetsCard').style.display='none';document.getElementById('uploadCard').style.display='none';document.getElementById('quickActions').style.display='block';showStatus('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­','success')}
function showUploadArea(){document.getElementById('uploadCard').style.display='block'}
function saveTargets(){D.targets.math=parseFloat(document.getElementById('targetMath').value)||50;D.targets.reading=parseFloat(document.getElementById('targetReading').value)||55;D.targets.science=parseFloat(document.getElementById('targetScience').value)||60;try{localStorage.setItem('nafesTargets',JSON.stringify(D.targets))}catch(e){}showStatus('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª!','success');if(D.raw.length>0)updateView()}
function loadTargets(){try{var s=localStorage.getItem('nafesTargets');if(s){D.targets=JSON.parse(s);document.getElementById('targetMath').value=D.targets.math;document.getElementById('targetReading').value=D.targets.reading;document.getElementById('targetScience').value=D.targets.science}}catch(e){}}
function setupFileUpload(){var a=document.getElementById('uploadArea'),inp=document.getElementById('fileInput');if(!a||!inp)return;a.onclick=function(){inp.click()};a.ondragover=function(e){e.preventDefault();a.classList.add('dragover')};a.ondragleave=function(){a.classList.remove('dragover')};a.ondrop=function(e){e.preventDefault();a.classList.remove('dragover');if(e.dataTransfer.files[0])processFile(e.dataTransfer.files[0])};inp.onchange=function(e){if(e.target.files[0])processFile(e.target.files[0])}}
async function processFile(file){if(!file.name.match(/\.xlsx?$/)){showStatus('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Excel','warning');return}var sp=document.getElementById('spinner');if(sp)sp.classList.add('show');showStatus('â³ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø©...','info');try{var buf=await file.arrayBuffer(),wb=XLSX.read(buf),rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);if(!rows.length)throw new Error('ÙØ§Ø±Øº');loadData(rows)}catch(err){showStatus('âŒ Ø®Ø·Ø£: '+err.message,'warning')}finally{if(sp)sp.classList.remove('show')}}
function populateSchools(){var sel=document.getElementById('schoolSelect');if(!sel)return;var s=new Set();for(var i=0;i<D.raw.length;i++){var n=D.raw[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']||D.raw[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];if(n&&typeof n==='string')s.add(n.trim())}var names=Array.from(s).sort();if(names.length>1){sel.innerHTML='<option value="">Ø§Ù„ÙƒÙ„</option>'+names.map(function(n){return'<option value="'+n+'">'+n+'</option>'}).join('');sel.disabled=false}else if(names.length===1){sel.innerHTML='<option value="'+names[0]+'">'+names[0]+'</option>';sel.disabled=true}}
function populateSelects(){var subjs=[...new Set(D.raw.map(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']}))].filter(Boolean);document.getElementById('subjectSelect').innerHTML='<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option>'+subjs.map(function(s){return'<option value="'+s+'">'+s+'</option>'}).join('')}

/* === DASHBOARD === */
function showDashboard(){showDashFiltered(D.raw);document.getElementById('dashboardCard').classList.remove('hidden')}
function showDashFiltered(bd){var subjs=['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','Ø§Ù„Ø¹Ù„ÙˆÙ…'],tm={'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':D.targets.math,'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':D.targets.reading,'Ø§Ù„Ø¹Ù„ÙˆÙ…':D.targets.science};var html='';for(var i=0;i<subjs.length;i++){var s=subjs[i],sd=getSD(bd,s,D.latestYear);if(sd.perf>0||sd.isMulti){var t=tm[s],cc='neutral',tt='';if(D.previousYear){var prev=getSD(bd,s,D.previousYear);if(prev.perf>0){var ch=(sd.perf-prev.perf).toFixed(1);if(ch>0){cc='improved';tt='<div class="trend">ğŸ“ˆ +'+ch+'%</div>'}else if(ch<0){cc='declined';tt='<div class="trend">ğŸ“‰ '+ch+'%</div>'}else tt='<div class="trend">â¡ï¸ Ø«Ø§Ø¨Øª</div>'}}var dd=(sd.perf-sd.dept).toFixed(1),kd=(sd.perf-sd.kingdom).toFixed(1),td=(sd.perf-t).toFixed(1);html+='<div class="stat-card '+cc+'"><h3>'+sd.perf.toFixed(1)+'%</h3><p>'+s+'</p>'+tt+'<div class="comparison"><div>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: '+sd.dept.toFixed(1)+'% ('+(dd>=0?'+':'')+dd+'%)</div><div>Ø§Ù„Ù…Ù…Ù„ÙƒØ©: '+sd.kingdom.toFixed(1)+'% ('+(kd>=0?'+':'')+kd+'%)</div><div>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: '+t+'% ('+(td>=0?'+':'')+td+'%)</div></div></div>'}}document.getElementById('currentYear').textContent=D.latestYear;document.getElementById('stats').innerHTML=html}

/* === COMPARISON TABLE === */
function showComparison(){var subjs=['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','Ø§Ù„Ø¹Ù„ÙˆÙ…'],tm={'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':D.targets.math,'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':D.targets.reading,'Ø§Ù„Ø¹Ù„ÙˆÙ…':D.targets.science};var html='<table class="comparison-table"><thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th><th>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</th><th>Ø§Ù„ÙØ¬ÙˆØ©</th><th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th><th>Ø§Ù„Ù…Ù…Ù„ÙƒØ©</th></tr></thead><tbody>';for(var i=0;i<subjs.length;i++){var s=subjs[i],sd=getSD(D.raw,s,D.latestYear);if(sd.perf>0||sd.isMulti){var t=tm[s],gap=(sd.perf-t).toFixed(1),gc=gap>=0?'#d4edda':'#f8d7da';html+='<tr><td><strong>'+s+'</strong></td><td><strong>'+sd.perf.toFixed(1)+'%</strong></td><td>'+t+'%</td><td style="background:'+gc+';font-weight:700">'+(gap>=0?'+':'')+gap+'%</td><td>'+sd.dept.toFixed(1)+'%</td><td>'+sd.kingdom.toFixed(1)+'%</td></tr>'}}html+='</tbody></table>';document.getElementById('comparisonTableContainer').innerHTML=html;document.getElementById('comparisonCard').classList.remove('hidden')}

/* === VIEW UPDATE === */
function updateView(){D.subject=document.getElementById('subjectSelect').value;var sel=document.getElementById('schoolSelect').value;var bd=D.raw;if(sel)bd=D.raw.filter(function(r){return r['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']===sel||r['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']===sel});showDashFiltered(bd);drawCharts(bd);generateReport(bd)}

/* === INTERACTIVE CHARTS (Tab 0) === */
function drawCharts(bd){var ld=bd.filter(function(r){return r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']===D.latestYear});var f=ld;if(D.subject!=='all')f=f.filter(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']===D.subject});var html='<h3 style="color:#4472C4">Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ù…Ù„ÙƒØ©</h3><div class="chart-container"><canvas id="c1"></canvas></div><h3 style="color:#4472C4">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù† ÙÙŠ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©</h3><div class="chart-container"><canvas id="c2"></canvas></div><h3 style="color:#4472C4">ØªÙˆØ²ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</h3><div class="chart-container"><canvas id="c3"></canvas></div><h3 style="color:#4472C4">ØªØ·ÙˆØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</h3><div class="chart-container"><canvas id="c4"></canvas></div>';document.getElementById('chartsContent').innerHTML=html;setTimeout(function(){drawInteractive(f,bd)},100)}
function drawInteractive(f,bd){var subjs=D.subject==='all'?['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','Ø§Ù„Ø¹Ù„ÙˆÙ…']:[D.subject],tm={'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':D.targets.math,'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':D.targets.reading,'Ø§Ù„Ø¹Ù„ÙˆÙ…':D.targets.science};var sD=[],dD=[],kD=[],tD=[];for(var i=0;i<subjs.length;i++){var sd=getSD(f,subjs[i],D.latestYear);sD.push(sd.perf);dD.push(sd.dept);kD.push(sd.kingdom);tD.push(tm[subjs[i]]||0)}if(D.charts.c1)D.charts.c1.destroy();var x=document.getElementById('c1');if(x)D.charts.c1=new Chart(x,{type:'bar',data:{labels:subjs,datasets:[{label:'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©',data:sD,backgroundColor:'#4472C4'},{label:'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',data:dD,backgroundColor:'#ffc107'},{label:'Ø§Ù„Ù…Ù…Ù„ÙƒØ©',data:kD,backgroundColor:'#28a745'},{label:'Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù',data:tD,type:'line',borderColor:'#dc3545',backgroundColor:'transparent',borderWidth:3,borderDash:[10,5],pointRadius:6,pointBackgroundColor:'#dc3545'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}}}});
var doms={};for(var i=0;i<f.length;i++){var r=f[i],d=r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'];if(d!==r['Ø§Ù„Ù…Ø¬Ø§Ù„']){if(!doms[d])doms[d]=[];doms[d].push(r['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†']||0)}}var lbl=Object.keys(doms),vals=lbl.map(function(l){return avg(doms[l])}),bgC=vals.map(function(v){return v>=60?'#28a745':v>=40?'#ffc107':'#dc3545'});if(D.charts.c2)D.charts.c2.destroy();var x2=document.getElementById('c2');if(x2)D.charts.c2=new Chart(x2,{type:'bar',data:{labels:lbl,datasets:[{label:'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù† (%)',data:vals,backgroundColor:bgC}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{beginAtZero:true,max:100}}}});
var h=[],m=[],l=[],vl=[];for(var i=0;i<f.length;i++){h.push(f[i]['Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø±ØªÙØ¹']||0);m.push(f[i]['Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªÙˆØ³Ø·']||0);l.push(f[i]['Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø®ÙØ¶']||0);vl.push(f[i]['Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§']||0)}if(D.charts.c3)D.charts.c3.destroy();var x3=document.getElementById('c3');if(x3)D.charts.c3=new Chart(x3,{type:'doughnut',data:{labels:['Ù…Ø±ØªÙØ¹','Ù…ØªÙˆØ³Ø·','Ù…Ù†Ø®ÙØ¶','Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹'],datasets:[{data:[avg(h),avg(m),avg(l),avg(vl)],backgroundColor:['#28a745','#36a2eb','#ffce56','#dc3545']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}});
var yrs=[...new Set(bd.map(function(r){return r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']}))].filter(Boolean).sort(),colors={'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':'#4472C4','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':'#28a745','Ø§Ù„Ø¹Ù„ÙˆÙ…':'#ffc107'},ds=[];for(var s=0;s<subjs.length;s++){var v=yrs.map(function(y){return getSD(bd,subjs[s],y).perf});ds.push({label:subjs[s],data:v,borderColor:colors[subjs[s]],backgroundColor:colors[subjs[s]]+'20',borderWidth:3,tension:.3,fill:true})}if(D.charts.c4)D.charts.c4.destroy();var x4=document.getElementById('c4');if(x4)D.charts.c4=new Chart(x4,{type:'line',data:{labels:yrs,datasets:ds},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}}}})}

/* === REPORT (Tab 1) - Charts rendered as IMAGES === */
async function generateReport(bd){if(!bd)bd=D.raw;var ld=bd.filter(function(r){return r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']===D.latestYear});var f=ld;if(D.subject!=='all')f=f.filter(function(r){return r['Ø§Ù„Ù…Ø¬Ø§Ù„']===D.subject});var subjs=D.subject==='all'?['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©','Ø§Ù„Ø¹Ù„ÙˆÙ…']:[D.subject],tm={'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª':D.targets.math,'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©':D.targets.reading,'Ø§Ù„Ø¹Ù„ÙˆÙ…':D.targets.science};var ss=new Set();for(var i=0;i<bd.length;i++){var n=bd[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']||bd[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];if(n)ss.add(n)}var isM=ss.size>1;var an=analyze(f,subjs,tm,isM);
// Build chart configs
var sD=[],dD=[];for(var i=0;i<subjs.length;i++){var sd=getSD(f,subjs[i],D.latestYear);sD.push(sd.perf);dD.push(sd.dept)}
var cfg1={type:'bar',data:{labels:subjs,datasets:[{label:'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©',data:sD,backgroundColor:'#4472C4'},{label:'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',data:dD,backgroundColor:'#ffc107'}]},options:{plugins:{title:{display:true,text:'Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',font:{size:16,family:'Tajawal'}}},scales:{y:{beginAtZero:true,max:100}}}};
var doms={};for(var i=0;i<f.length;i++){var r=f[i],d=r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'];if(d!==r['Ø§Ù„Ù…Ø¬Ø§Ù„']){if(!doms[d])doms[d]=[];doms[d].push(r['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†']||0)}}var lbl=Object.keys(doms),vals=lbl.map(function(l){return avg(doms[l])}),bgC=vals.map(function(v){return v>=60?'#28a745':v>=40?'#ffc107':'#dc3545'});
var cfg2={type:'bar',data:{labels:lbl,datasets:[{label:'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù†',data:vals,backgroundColor:bgC}]},options:{indexAxis:'y',plugins:{title:{display:true,text:'Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©',font:{size:16,family:'Tajawal'}}},scales:{x:{beginAtZero:true,max:100}}}};
// Render charts to images
var img1=await renderChartToImage(cfg1,800,400);
var img2=await renderChartToImage(cfg2,800,Math.max(300,lbl.length*50+80));
// Build HTML with IMG tags (NOT canvas)
var html='<div class="report-section"><div class="report-header"><h1>'+D.school+'</h1><h2>ØªÙ‚Ø±ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ù†Ø§ÙØ³ Ø§Ù„ÙˆØ·Ù†ÙŠØ©</h2><h3>Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: '+D.latestYear+'</h3></div><div class="report-stats">';
for(var i=0;i<subjs.length;i++){var sd=getSD(bd,subjs[i],D.latestYear);if(sd.perf>0||sd.isMulti)html+='<div class="report-stat"><h3>'+subjs[i]+'</h3><h2 style="color:#4472C4;font-size:2.5em">'+sd.perf.toFixed(1)+'%</h2><p>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: '+tm[subjs[i]]+'%</p></div>'}
html+='</div></div>';
html+='<div class="report-section"><div class="strengths-box"><h3>âœ… Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©</h3><ul>';for(var i=0;i<an.strengths.length;i++)html+='<li>'+an.strengths[i]+'</li>';html+='</ul></div></div>';
html+='<div class="report-section"><div class="weaknesses-box"><h3>âš ï¸ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù</h3><ul>';for(var i=0;i<an.weaknesses.length;i++)html+='<li>'+an.weaknesses[i]+'</li>';html+='</ul></div></div>';
html+='<div class="report-section"><div class="recommendations-box"><h3>ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ§Øª</h3><ol>';for(var i=0;i<an.recommendations.length;i++)html+='<li>'+an.recommendations[i]+'</li>';html+='</ol></div></div>';
// CHARTS AS IMAGES
html+='<div class="report-section"><h3 style="color:#4472C4;text-align:center;margin-bottom:20px">ğŸ“Š Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</h3>';
if(img1)html+='<div style="background:#f9f9f9;border-radius:10px;padding:20px;margin:15px 0;text-align:center"><img src="'+img1+'" style="width:100%;max-width:700px;height:auto;display:block;margin:0 auto"></div>';
if(img2)html+='<div style="background:#f9f9f9;border-radius:10px;padding:20px;margin:15px 0;text-align:center"><img src="'+img2+'" style="width:100%;max-width:700px;height:auto;display:block;margin:0 auto"></div>';
html+='</div>';
document.getElementById('reportPreview').innerHTML=html}

function analyze(f,subjs,tm,isM){var st=[],wk=[],rc=[];for(var i=0;i<subjs.length;i++){var s=subjs[i],sd=getSD(f,s,D.latestYear),t=tm[s];if(sd.perf>=t)st.push(s+' Ø­Ù‚Ù‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ø¨Ù†Ø³Ø¨Ø© '+sd.perf.toFixed(1)+'%');if(sd.perf>sd.dept)st.push(s+' ØªÙÙˆÙ‚Øª Ø¹Ù„Ù‰ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ('+sd.dept.toFixed(1)+'%)');if(sd.perf<t){var g=(t-sd.perf).toFixed(1);wk.push(s+' Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ø¨Ù€ '+g+'%');rc.push('ØªÙ†ÙÙŠØ° Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙ‚ÙˆÙŠØ© ÙÙŠ '+s)}if(sd.perf<sd.dept)wk.push(s+' Ø£Ù‚Ù„ Ù…Ù† Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©')}var doms={};for(var i=0;i<f.length;i++){var r=f[i],d=r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'];if(d!==r['Ø§Ù„Ù…Ø¬Ø§Ù„'])doms[d]=r['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†']||0}var sorted=Object.entries(doms).sort(function(a,b){return b[1]-a[1]});if(sorted.length>0&&!isM){st.push('Ø£ÙØ¶Ù„ Ù…Ø¬Ø§Ù„: '+sorted[0][0]+' ('+sorted[0][1]+'%)');var w=sorted[sorted.length-1];if(w[1]<50){wk.push('Ø£Ø¶Ø¹Ù Ù…Ø¬Ø§Ù„: '+w[0]+' ('+w[1]+'%)');rc.push('Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† '+w[0])}}if(!st.length)st.push('ÙŠÙˆØ¬Ø¯ Ù…Ø¬Ø§Ù„ Ù„Ù„ØªØ­Ø³ÙŠÙ†');return{strengths:st,weaknesses:wk,recommendations:rc}}

/* === PDF EXPORT (GUARANTEED - uses img not canvas) === */
async function exportPDF(){var rp=document.getElementById('reportPreview');if(!rp||!rp.innerHTML.trim()){alert('âš ï¸ Ø§Ù†ØªÙ‚Ù„ Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹');return}
var ov=document.createElement('div');ov.className='pdf-overlay';ov.innerHTML='<div class="pdf-overlay-content"><h3>ğŸ“„ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF</h3><p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</p><div class="pdf-progress"><div class="pdf-progress-bar"></div></div></div>';document.body.appendChild(ov);
try{var clone=rp.cloneNode(true);clone.style.cssText='direction:rtl;font-family:Tajawal,sans-serif;padding:20px;background:white;width:190mm;position:absolute;left:-99999px;top:0';document.body.appendChild(clone);await new Promise(function(r){setTimeout(r,500)});
await html2pdf().set({margin:[10,10,15,10],filename:'ØªÙ‚Ø±ÙŠØ±_Ù†Ø§ÙØ³.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true,letterRendering:true},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},pagebreak:{mode:['avoid-all','css','legacy']}}).from(clone).save();
document.body.removeChild(clone)}catch(e){console.error(e);alert('âŒ Ø®Ø·Ø£. Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø«Ù… Ø­ÙØ¸ ÙƒÙ€ PDF')}finally{if(ov.parentNode)ov.parentNode.removeChild(ov)}}

/* === PRINT (uses img not canvas) === */
function printReport(){var rp=document.getElementById('reportPreview');if(!rp||!rp.innerHTML.trim()){alert('âš ï¸ Ø§Ù†ØªÙ‚Ù„ Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹');return}
var pw=window.open('','_blank');if(!pw){alert('âš ï¸ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©');return}
pw.document.write('<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>ØªÙ‚Ø±ÙŠØ± Ù†Ø§ÙØ³</title><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"><\/script><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Tajawal,sans-serif;padding:20px;background:#f5f5f5;direction:rtl}.pc{max-width:800px;margin:0 auto;background:#fff;padding:40px;box-shadow:0 0 20px rgba(0,0,0,.1)}.pa{position:fixed;top:20px;left:20px;background:#fff;padding:15px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;display:flex;gap:10px}.pa button{background:#4472C4;color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-family:Tajawal,sans-serif}.pa .bp{background:#dc3545}.report-header{text-align:center;padding:30px;background:linear-gradient(135deg,#4472C4,#764ba2);color:#fff;border-radius:10px;margin-bottom:30px;-webkit-print-color-adjust:exact;print-color-adjust:exact}.report-stats{display:flex;justify-content:space-around;margin:30px 0;gap:20px}.report-stat{text-align:center;padding:20px;background:#f8f9fa;border-radius:10px;flex:1;border:2px solid #e0e0e0}.report-stat h2{color:#4472C4;font-size:2.5em}.strengths-box,.weaknesses-box,.recommendations-box{margin:25px 0;padding:20px;border-radius:10px;-webkit-print-color-adjust:exact;print-color-adjust:exact}.strengths-box{background:#d4edda;border:2px solid #28a745}.strengths-box h3{color:#155724;margin-bottom:15px}.weaknesses-box{background:#f8d7da;border:2px solid #dc3545}.weaknesses-box h3{color:#721c24;margin-bottom:15px}.recommendations-box{background:#fff3cd;border:2px solid #ffc107}.recommendations-box h3{color:#856404;margin-bottom:15px}ul{list-style:none;padding:0}li{padding:10px 0;border-bottom:1px solid rgba(0,0,0,.1)}ol{padding-right:25px}img{max-width:100%;height:auto;display:block;margin:10px auto}.report-section{page-break-inside:avoid;margin-bottom:20px}@media print{body{background:#fff;padding:0}.pc{box-shadow:none;padding:20px}.pa{display:none}.report-header,.strengths-box,.weaknesses-box,.recommendations-box,.report-stat{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}}</style></head><body><div class="pa"><button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button class="bp" onclick="dlPdf()">ğŸ“¥ PDF</button><button onclick="window.close()">âŒ Ø¥ØºÙ„Ø§Ù‚</button></div><div class="pc" id="pc">'+rp.innerHTML+'</div><script>function dlPdf(){html2pdf().set({margin:[10,10,15,10],filename:"ØªÙ‚Ø±ÙŠØ±_Ù†Ø§ÙØ³.pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["avoid-all","css","legacy"]}}).from(document.getElementById("pc")).save()}<\/script></body></html>');pw.document.close()}
</script>
</body>
</html>
