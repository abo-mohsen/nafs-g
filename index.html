<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ù†Ø§ÙØ³ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4472C4 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header {
            text-align: center;
            background: linear-gradient(135deg, #4472C4 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 { font-size: 2.5em; margin-bottom: 10px; }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .targets-section {
            background: #f0f4ff;
            border: 2px solid #4472C4;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .targets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .target-input {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .target-input h4 {
            color: #4472C4;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .target-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .target-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1.1em;
        }

        .upload-area {
            border: 3px dashed #4472C4;
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(68, 114, 196, 0.05);
        }

        .upload-area:hover {
            background: rgba(68, 114, 196, 0.15);
            transform: scale(1.02);
        }

        .upload-icon { font-size: 5em; margin-bottom: 20px; }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .stat-card.improved {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .stat-card.declined {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .stat-card.neutral {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .stat-card h3 { font-size: 2.5em; margin-bottom: 5px; }
        .stat-card p { font-size: 1.1em; margin-bottom: 5px; }
        .stat-card .comparison {
            font-size: 0.85em;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        .stat-card .trend {
            font-size: 0.9em;
            margin-top: 5px;
            font-weight: bold;
        }

        .comparison-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 15px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .comparison-table th {
            background: linear-gradient(135deg, #4472C4 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1.1em;
        }

        .btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #4472C4 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(68, 114, 196, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            padding: 25px;
            background: #f9f9f9;
            border-radius: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 30px;
            background: #f0f0f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #4472C4 0%, #764ba2 100%);
            color: white;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .report-section {
            page-break-inside: avoid;
            margin-bottom: 30px;
        }

        .report-header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #4472C4 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .report-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .strengths-box {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .strengths-box h3 {
            color: #155724;
            margin-bottom: 15px;
        }

        .strengths-box ul {
            list-style: none;
            padding: 0;
        }

        .strengths-box li {
            padding: 10px 0;
            border-bottom: 1px solid #c3e6cb;
        }

        .strengths-box li:before {
            content: "âœ… ";
            margin-left: 10px;
        }

        .weaknesses-box {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .weaknesses-box h3 {
            color: #721c24;
            margin-bottom: 15px;
        }

        .weaknesses-box ul {
            list-style: none;
            padding: 0;
        }

        .weaknesses-box li {
            padding: 10px 0;
            border-bottom: 1px solid #f5c6cb;
        }

        .weaknesses-box li:before {
            content: "âš ï¸ ";
            margin-left: 10px;
        }

        .recommendations-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .recommendations-box h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .recommendations-box ol {
            padding-right: 20px;
        }

        .recommendations-box li {
            padding: 10px 0;
            border-bottom: 1px solid #ffeaa7;
        }

        .alert {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.1em;
        }

        .alert-info { background: #d1ecf1; border: 2px solid #bee5eb; color: #0c5460; }
        .alert-success { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; }
        .alert-warning { background: #fff3cd; border: 2px solid #ffc107; color: #856404; }

        .spinner {
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid #4472C4;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
            display: none;
        }

        .spinner.show { display: block; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden { display: none !important; }

        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }
            
            body * {
                visibility: hidden;
            }
            
            #printableReport,
            #printableReport * {
                visibility: visible !important;
            }
            
            #printableReport {
                position: absolute;
                left: 0;
                top: 0;
                display: block !important;
                width: 100%;
            }
            
            /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª */
            #printableReport canvas {
                display: block !important;
                visibility: visible !important;
                max-width: 100% !important;
                height: auto !important;
            }
            
            #printableReport .chart-container {
                display: block !important;
                visibility: visible !important;
                page-break-inside: avoid;
                margin: 20px 0;
            }
            
            /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
            #printableReport .report-header {
                text-align: center;
                margin-bottom: 30px;
            }
            
            #printableReport .report-stats {
                display: flex !important;
                justify-content: space-around;
                margin: 30px 0;
            }
            
            #printableReport .report-section {
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            
            #printableReport .strengths-box,
            #printableReport .weaknesses-box,
            #printableReport .recommendations-box {
                padding: 15px;
                margin: 15px 0;
                border: 2px solid #ddd;
                border-radius: 8px;
            }
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .dashboard { grid-template-columns: 1fr; }
            .targets-grid { grid-template-columns: 1fr; }
            .report-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header no-print">
            <h1>ğŸ“Š Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ù†Ø§ÙØ³ Ø§Ù„ÙˆØ·Ù†ÙŠØ©</h1>
            <p style="font-size: 1.2em;">Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù…Ø¹ ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ ÙˆÙ†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„Ø¶Ø¹Ù</p>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª -->
        <div class="card no-print">
            <div class="targets-section">
                <h2 style="color: #4472C4; margin-bottom: 20px;">ğŸ¯ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø©</h2>
                <p style="margin-bottom: 20px; color: #666;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø© (Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©)</p>
                
                <div class="targets-grid">
                    <div class="target-input">
                        <h4>ğŸ“ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</h4>
                        <label>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (%)</label>
                        <input type="number" id="targetMath" placeholder="Ù…Ø«Ø§Ù„: 50" value="50" min="0" max="100">
                    </div>

                    <div class="target-input">
                        <h4>ğŸ“– Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</h4>
                        <label>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (%)</label>
                        <input type="number" id="targetReading" placeholder="Ù…Ø«Ø§Ù„: 55" value="55" min="0" max="100">
                    </div>

                    <div class="target-input">
                        <h4>ğŸ”¬ Ø§Ù„Ø¹Ù„ÙˆÙ…</h4>
                        <label>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (%)</label>
                        <input type="number" id="targetScience" placeholder="Ù…Ø«Ø§Ù„: 60" value="60" min="0" max="100">
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveTargets()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª</button>
                </div>
            </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù -->
        <div class="card no-print" id="uploadCard" style="display: none;">
            <h2 style="color: #4472C4; margin-bottom: 25px; text-align: center;">ğŸ“ Ø§Ø±ÙØ¹ Ù…Ù„Ù Ù†Ø§ÙØ³</h2>
            
            <div class="alert alert-info">
                <strong>ğŸ’¡ ØªØ¹Ù„ÙŠÙ…Ø§Øª:</strong>
                <br>â€¢ Ø§Ø±ÙØ¹ Ù…Ù„Ù Ù†Ø§ÙØ³ Ø§Ù„Ø±Ø³Ù…ÙŠ (.xlsx)
                <br>â€¢ Ø³ÙŠØªÙ… Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ø¢Ø®Ø± Ø³Ù†Ø©
                <br>â€¢ Ø³ØªØ¸Ù‡Ø± Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„Ø¶Ø¹Ù ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            </div>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“¤</div>
                <h2>Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ù‡Ù†Ø§</h2>
                <p style="font-size: 1.2em; margin: 15px 0;">Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            </div>

            <div class="spinner" id="spinner"></div>
            <div id="status"></div>
        </div>
        
        <!-- Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ù…Ø®ØªÙ„Ù -->
        <div class="card no-print" id="uploadButton" style="display: none; text-align: center;">
            <button class="btn" onclick="showUploadArea()" style="font-size: 1.1em; padding: 12px 30px;">
                ğŸ“ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ù…Ø®ØªÙ„Ù
            </button>
        </div>

        <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
        <div class="card hidden no-print" id="dashboardCard">
            <h2 style="color: #4472C4; margin-bottom: 20px;">ğŸ“ˆ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… <span id="currentYear"></span></h2>
            <div class="dashboard" id="stats"></div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© -->
        <div class="card hidden no-print" id="comparisonCard">
            <h2 style="color: #4472C4; margin-bottom: 20px;">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h2>
            <div id="comparisonTableContainer"></div>
        </div>

        <!-- Ø§Ù„ØªØ­ÙƒÙ… -->
        <div class="card hidden no-print" id="controlsCard">
            <h2 style="color: #4472C4; margin-bottom: 20px;">âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶</h2>
            <div class="controls">
                <div class="form-group">
                    <label>ğŸ“š Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                    <select id="subjectSelect" onchange="updateView()">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ğŸ« Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø©</label>
                    <select id="schoolSelect" onchange="updateView()">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
        <div class="card hidden" id="mainCard">
            <div class="tabs no-print">
                <button class="tab active" onclick="switchTab(0)">ğŸ“Š Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª</button>
                <button class="tab" onclick="switchTab(1)">ğŸ“„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„</button>
            </div>

            <!-- Tab: Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª -->
            <div class="tab-content active" id="tab0">
                <div id="chartsContent"></div>
            </div>

            <!-- Tab: Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
            <div class="tab-content" id="tab1">
                <div id="reportPreview"></div>
                <div style="text-align: center; margin-top: 30px;" class="no-print">
                    <button class="btn" onclick="exportPDF()">ğŸ“¥ ØªØµØ¯ÙŠØ± PDF</button>
                    <button class="btn" onclick="printReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                </div>
            </div>
        </div>
        
        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø®ÙÙŠØ© -->
        <div id="printableReport" style="display: none;">
            <div id="reportContent"></div>
        </div>
    </div>

    <script>
        let data = { 
            raw: [], 
            school: '', 
            subject: 'all',
            latestYear: '',
            previousYear: '',
            charts: {},
            targets: {
                math: 50,
                reading: 55,
                science: 60
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadTargets();
            setupFileUpload();
            autoLoadData(); // ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        });
        
        function autoLoadData() {
            showStatus('â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
            fetch('data.xlsx')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    }
                    return response.arrayBuffer();
                })
                .then(buffer => {
                    const wb = XLSX.read(buffer);
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    if (!rows.length) {
                        throw new Error('Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©');
                    }
                    
                    data.raw = rows;
                    
                    // Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                    const schoolsSet = new Set();
                    for (let i = 0; i < rows.length; i++) {
                        const schoolName = rows[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || rows[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];
                        if (schoolName) schoolsSet.add(schoolName);
                    }
                    const schoolsCount = schoolsSet.size;
                    
                    if (schoolsCount === 1) {
                        data.school = Array.from(schoolsSet)[0];
                    } else if (schoolsCount > 1) {
                        data.school = 'Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª (' + schoolsCount + ' Ù…Ø¯Ø±Ø³Ø©)';
                    } else {
                        data.school = 'Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§ÙØ³';
                    }
                    
                    const years = [...new Set(rows.map(r => r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']))].filter(Boolean).sort();
                    data.latestYear = years[years.length - 1];
                    data.previousYear = years.length > 1 ? years[years.length - 2] : null;
                    
                    populateSelects();
                    populateSchoolsList();
                    showDashboard();
                    showComparison();
                    showControls();
                    showMain();
                    updateView();
                    
                    if (schoolsCount === 1) {
                        showStatus('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ ' + data.school + ' Ù„Ù„Ø¹Ø§Ù… ' + data.latestYear, 'success');
                    } else if (schoolsCount > 1) {
                        showStatus('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ' + schoolsCount + ' Ù…Ø¯Ø±Ø³Ø© - Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø© Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'success');
                    }
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    document.getElementById('uploadCard').style.display = 'none';
                    document.getElementById('uploadButton').style.display = 'block';
                })
                .catch(error => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                    showStatus('âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ - ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹', 'warning');
                    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹
                    document.getElementById('uploadCard').style.display = 'block';
                    document.getElementById('uploadButton').style.display = 'none';
                });
        }
        
        function showUploadArea() {
            document.getElementById('uploadCard').style.display = 'block';
            document.getElementById('uploadButton').style.display = 'none';
        }

        function saveTargets() {
            data.targets.math = parseFloat(document.getElementById('targetMath').value) || 50;
            data.targets.reading = parseFloat(document.getElementById('targetReading').value) || 55;
            data.targets.science = parseFloat(document.getElementById('targetScience').value) || 60;
            
            localStorage.setItem('nafesTargets', JSON.stringify(data.targets));
            showStatus('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            
            if (data.raw.length > 0) updateView();
        }

        function loadTargets() {
            const saved = localStorage.getItem('nafesTargets');
            if (saved) {
                try {
                    data.targets = JSON.parse(saved);
                    document.getElementById('targetMath').value = data.targets.math;
                    document.getElementById('targetReading').value = data.targets.reading;
                    document.getElementById('targetScience').value = data.targets.science;
                } catch(e) {
                    console.log('Error loading targets:', e);
                }
            }
        }

        function setupFileUpload() {
            const area = document.getElementById('uploadArea');
            const input = document.getElementById('fileInput');
            
            area.onclick = function() { input.click(); };
            
            area.ondragover = function(e) {
                e.preventDefault();
                area.classList.add('dragover');
            };
            
            area.ondragleave = function() {
                area.classList.remove('dragover');
            };
            
            area.ondrop = function(e) {
                e.preventDefault();
                area.classList.remove('dragover');
                if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
            };
            
            input.onchange = function(e) {
                if (e.target.files[0]) processFile(e.target.files[0]);
            };
        }

        async function processFile(file) {
            if (!file.name.match(/\.xlsx?$/)) {
                showStatus('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Excel (.xlsx)', 'warning');
                return;
            }

            document.getElementById('spinner').classList.add('show');
            showStatus('â³ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...', 'info');

            try {
                const buffer = await file.arrayBuffer();
                const wb = XLSX.read(buffer);
                const sheet = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet);

                if (!rows.length) throw new Error('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº');

                data.raw = rows;
                
                // Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                const schoolsSet = new Set();
                for (let i = 0; i < rows.length; i++) {
                    const schoolName = rows[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || rows[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];
                    if (schoolName) schoolsSet.add(schoolName);
                }
                const schoolsCount = schoolsSet.size;
                
                console.log('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù„Ù:');
                console.log('  - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', rows.length);
                console.log('  - Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ÙØ¹Ù„ÙŠ:', schoolsCount);
                console.log('  - Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„ÙƒÙ„ Ù…Ø¯Ø±Ø³Ø©:', (rows.length / schoolsCount).toFixed(1));
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                if (schoolsCount === 1) {
                    data.school = Array.from(schoolsSet)[0];
                } else if (schoolsCount > 1) {
                    data.school = 'Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª (' + schoolsCount + ' Ù…Ø¯Ø±Ø³Ø©)';
                } else {
                    data.school = file.name.replace(/\.xlsx?$/gi, '').trim();
                }
                
                const years = [...new Set(rows.map(r => r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']))].filter(Boolean).sort();
                data.latestYear = years[years.length - 1];
                data.previousYear = years.length > 1 ? years[years.length - 2] : null;

                console.log('Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:', years);
                console.log('Ø¢Ø®Ø± Ø³Ù†Ø©:', data.latestYear);

                populateSelects();
                populateSchoolsList();
                showDashboard();
                showComparison();
                showControls();
                showMain();
                updateView();

                if (schoolsCount === 1) {
                    showStatus('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ ' + data.school + ' Ù„Ù„Ø¹Ø§Ù… ' + data.latestYear, 'success');
                } else if (schoolsCount > 1) {
                    showStatus('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ' + schoolsCount + ' Ù…Ø¯Ø±Ø³Ø© - Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø© Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'success');
                } else {
                    showStatus('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù', 'success');
                }
            } catch (err) {
                console.error('Error:', err);
                showStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + err.message, 'warning');
            } finally {
                document.getElementById('spinner').classList.remove('show');
            }
        }

        function populateSchoolsList() {
            const schoolSelect = document.getElementById('schoolSelect');
            if (!schoolSelect) return;

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ÙØ±ÙŠØ¯Ø©
            const schoolsSet = new Set();
            for (let i = 0; i < data.raw.length; i++) {
                const schoolName = data.raw[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || data.raw[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];
                if (schoolName && typeof schoolName === 'string' && schoolName.trim()) {
                    schoolsSet.add(schoolName.trim());
                }
            }
            
            const schoolNames = Array.from(schoolsSet).sort();
            
            console.log('ğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…ØªØ§Ø­Ø©:', schoolNames.length);
            
            if (schoolNames.length > 1) {
                let html = '<option value="">Ø§Ù„ÙƒÙ„</option>';
                for (let i = 0; i < schoolNames.length; i++) {
                    html += '<option value="' + schoolNames[i] + '">' + schoolNames[i] + '</option>';
                }
                schoolSelect.innerHTML = html;
                schoolSelect.disabled = false;
            } else if (schoolNames.length === 1) {
                schoolSelect.innerHTML = '<option value="' + schoolNames[0] + '">' + schoolNames[0] + '</option>';
                schoolSelect.disabled = true;
            } else {
                schoolSelect.innerHTML = '<option value="">ØºÙŠØ± Ù…ØªÙˆÙØ±</option>';
                schoolSelect.disabled = true;
            }
        }

        function populateSelects() {
            const subjects = [...new Set(data.raw.map(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„']))];
            document.getElementById('subjectSelect').innerHTML = 
                '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option>' + 
                subjects.map(s => '<option value="' + s + '">' + s + '</option>').join('');
            
            const schoolNames = [...new Set(data.raw.map(r => r['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || r['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©']).filter(Boolean))];
            const schoolSelect = document.getElementById('schoolSelect');
            
            if (schoolNames.length > 1) {
                schoolSelect.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>' + 
                    schoolNames.map(s => '<option value="' + s + '">' + s + '</option>').join('');
                schoolSelect.disabled = false;
            } else if (schoolNames.length === 1) {
                schoolSelect.innerHTML = '<option value="' + schoolNames[0] + '">' + schoolNames[0] + '</option>';
                schoolSelect.disabled = true;
            } else {
                schoolSelect.innerHTML = '<option value="">ØºÙŠØ± Ù…ØªÙˆÙØ±</option>';
                schoolSelect.disabled = true;
            }
        }

        function showDashboard() {
            // Ø¹Ù†Ø¯ Ø±ÙØ¹ Ù…Ù„Ù Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø©
            const schoolsSet = new Set();
            for (let i = 0; i < data.raw.length; i++) {
                const schoolName = data.raw[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || data.raw[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];
                if (schoolName) schoolsSet.add(schoolName);
            }
            
            if (schoolsSet.size > 1) {
                // Ù…Ù„Ù Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ - Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù…
                showDashboardFiltered(data.raw);
                document.getElementById('dashboardCard').classList.remove('hidden');
                return;
            }
            
            // Ù…Ù„Ù Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ø­Ø¯Ø© - Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
            showDashboardFiltered(data.raw);
            document.getElementById('dashboardCard').classList.remove('hidden');
        }

        function showDashboardFiltered(baseData) {
            const latestData = baseData.filter(r => r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ'] === data.latestYear);
            const previousData = data.previousYear ? baseData.filter(r => r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ'] === data.previousYear) : null;
            
            const subjects = ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'Ø§Ù„Ø¹Ù„ÙˆÙ…'];
            const targetMap = {
                'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª': data.targets.math,
                'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©': data.targets.reading,
                'Ø§Ù„Ø¹Ù„ÙˆÙ…': data.targets.science
            };
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
            const schoolsSet = new Set();
            for (let i = 0; i < baseData.length; i++) {
                const schoolName = baseData[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || baseData[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];
                if (schoolName) schoolsSet.add(schoolName);
            }
            const isMultipleSchools = schoolsSet.size > 1;
            
            console.log('ğŸ“Š ØªØ´Ø®ÙŠØµ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª:');
            console.log('Ø§Ù„Ø¹Ø§Ù…:', data.latestYear);
            console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', latestData.length);
            console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:', schoolsSet.size);
            
            let html = '';
            
            for (let i = 0; i < subjects.length; i++) {
                const subject = subjects[i];
                
                let perf = 0;
                let dept = 0;
                let kingdom = 0;
                
                if (isMultipleSchools) {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø±Ø¬Ø­ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                    const subjectData = latestData.filter(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                    
                    let totalStudents = 0;
                    let totalProficient = 0;
                    let sumDept = 0;
                    let sumKingdom = 0;
                    let count = 0;
                    
                    for (let j = 0; j < subjectData.length; j++) {
                        const students = subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†'] || 0;
                        const proficient = subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                        totalStudents += students;
                        totalProficient += proficient;
                        sumDept += subjectData[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…'] || 0;
                        sumKingdom += subjectData[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©'] || 0;
                        count++;
                    }
                    
                    if (totalStudents > 0) {
                        perf = (totalProficient / totalStudents) * 100;
                        dept = count > 0 ? sumDept / count : 0;
                        kingdom = count > 0 ? sumKingdom / count : 0;
                    }
                    
                    console.log('---');
                    console.log('Ø§Ù„Ù…Ø§Ø¯Ø©:', subject);
                    console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:', count);
                    console.log('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨:', totalStudents);
                    console.log('Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù…:', perf.toFixed(1) + '%');
                    
                } else {
                    // Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ø­Ø¯Ø© - Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                    const current = latestData.find(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                    
                    if (current) {
                        perf = current['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                        dept = current['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…'] || 0;
                        kingdom = current['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©'] || 0;
                        
                        console.log('---');
                        console.log('Ø§Ù„Ù…Ø§Ø¯Ø©:', subject);
                        console.log('Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†:', perf);
                    }
                }
                
                if (perf > 0 || isMultipleSchools) {
                    const target = targetMap[subject];
                    
                    let warningText = '';
                    if (perf > 100 || perf < 0) {
                        warningText = '<div style="color: #fff; background: #dc3545; padding: 5px; margin-top: 5px; border-radius: 5px; font-size: 0.9em;">âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©!</div>';
                        perf = Math.min(100, Math.max(0, perf));
                    }
                    
                    let cardClass = 'neutral';
                    let trendText = '';
                    
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ­Ø³Ù† (Ù„Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù… Ø£Ùˆ Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ø­Ø¯Ø©)
                    if (previousData && previousData.length > 0) {
                        let prevPerf = 0;
                        
                        if (isMultipleSchools) {
                            const prevSubjectData = previousData.filter(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                            let prevTotal = 0;
                            let prevProf = 0;
                            for (let j = 0; j < prevSubjectData.length; j++) {
                                prevTotal += prevSubjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†'] || 0;
                                prevProf += prevSubjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                            }
                            if (prevTotal > 0) prevPerf = (prevProf / prevTotal) * 100;
                        } else {
                            const previous = previousData.find(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                            if (previous) prevPerf = previous['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                        }
                        
                        if (prevPerf > 0) {
                            const change = (perf - prevPerf).toFixed(1);
                            if (change > 0) {
                                cardClass = 'improved';
                                trendText = '<div class="trend">ğŸ“ˆ ØªØ­Ø³Ù†: +' + change + '%</div>';
                            } else if (change < 0) {
                                cardClass = 'declined';
                                trendText = '<div class="trend">ğŸ“‰ ØªØ±Ø§Ø¬Ø¹: ' + change + '%</div>';
                            } else {
                                trendText = '<div class="trend">â¡ï¸ Ø«Ø§Ø¨Øª</div>';
                            }
                        }
                    }
                    
                    const deptDiff = (perf - dept).toFixed(1);
                    const kingdomDiff = (perf - kingdom).toFixed(1);
                    const targetDiff = (perf - target).toFixed(1);
                    
                    html += '<div class="stat-card ' + cardClass + '">';
                    html += '<h3>' + perf.toFixed(1) + '%</h3>';
                    html += '<p>' + subject + '</p>';
                    if (isMultipleSchools) {
                        html += '<p style="font-size: 0.85em; opacity: 0.9;">(' + schoolsSet.size + ' Ù…Ø¯Ø±Ø³Ø©)</p>';
                    }
                    html += trendText;
                    html += warningText;
                    html += '<div class="comparison">';
                    html += '<div>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: ' + dept.toFixed(1) + '% (' + (deptDiff >= 0 ? '+' : '') + deptDiff + '%)</div>';
                    html += '<div>Ø§Ù„Ù…Ù…Ù„ÙƒØ©: ' + kingdom.toFixed(1) + '% (' + (kingdomDiff >= 0 ? '+' : '') + kingdomDiff + '%)</div>';
                    html += '<div>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: ' + target + '% (' + (targetDiff >= 0 ? '+' : '') + targetDiff + '%)</div>';
                    html += '</div></div>';
                }
            }

            document.getElementById('currentYear').textContent = data.latestYear;
            document.getElementById('stats').innerHTML = html;
        }

        function showComparison() {
            const latestData = data.raw.filter(r => r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ'] === data.latestYear);
            const subjects = ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'Ø§Ù„Ø¹Ù„ÙˆÙ…'];
            const targetMap = {
                'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª': data.targets.math,
                'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©': data.targets.reading,
                'Ø§Ù„Ø¹Ù„ÙˆÙ…': data.targets.science
            };
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
            const schoolsSet = new Set();
            for (let i = 0; i < data.raw.length; i++) {
                const schoolName = data.raw[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || data.raw[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];
                if (schoolName) schoolsSet.add(schoolName);
            }
            const isMultipleSchools = schoolsSet.size > 1;
            
            let html = '<table class="comparison-table"><thead><tr>';
            html += '<th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th><th>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</th><th>Ø§Ù„ÙØ¬ÙˆØ©</th><th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th><th>Ø§Ù„Ù…Ù…Ù„ÙƒØ©</th>';
            html += '</tr></thead><tbody>';

            for (let i = 0; i < subjects.length; i++) {
                const subject = subjects[i];
                let school = 0;
                let dept = 0;
                let kingdom = 0;
                
                if (isMultipleSchools) {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø±Ø¬Ø­
                    const subjectData = latestData.filter(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                    let totalStudents = 0;
                    let totalProficient = 0;
                    let sumDept = 0;
                    let sumKingdom = 0;
                    let count = 0;
                    
                    for (let j = 0; j < subjectData.length; j++) {
                        totalStudents += subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†'] || 0;
                        totalProficient += subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                        sumDept += subjectData[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…'] || 0;
                        sumKingdom += subjectData[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©'] || 0;
                        count++;
                    }
                    
                    if (totalStudents > 0) {
                        school = (totalProficient / totalStudents) * 100;
                        dept = count > 0 ? sumDept / count : 0;
                        kingdom = count > 0 ? sumKingdom / count : 0;
                    }
                } else {
                    // Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ø­Ø¯Ø©
                    const subjectData = latestData.find(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                    if (subjectData) {
                        school = subjectData['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                        dept = subjectData['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…'] || 0;
                        kingdom = subjectData['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©'] || 0;
                    }
                }
                
                if (school > 0 || isMultipleSchools) {
                    const target = targetMap[subject];
                    const gap = (school - target).toFixed(1);
                    const gapColor = gap >= 0 ? '#d4edda' : '#f8d7da';
                    
                    html += '<tr>';
                    html += '<td><strong>' + subject + '</strong></td>';
                    html += '<td><strong>' + school.toFixed(1) + '%</strong></td>';
                    html += '<td>' + target + '%</td>';
                    html += '<td style="background: ' + gapColor + '; font-weight: bold;">' + (gap >= 0 ? '+' : '') + gap + '%</td>';
                    html += '<td>' + dept.toFixed(1) + '%</td>';
                    html += '<td>' + kingdom.toFixed(1) + '%</td>';
                    html += '</tr>';
                }
            }

            html += '</tbody></table>';
            
            document.getElementById('comparisonTableContainer').innerHTML = html;
            document.getElementById('comparisonCard').classList.remove('hidden');
        }

        function showControls() {
            document.getElementById('controlsCard').classList.remove('hidden');
        }

        function showMain() {
            document.getElementById('mainCard').classList.remove('hidden');
        }

        function updateView() {
            data.subject = document.getElementById('subjectSelect').value;
            const selectedSchool = document.getElementById('schoolSelect').value;
            
            console.log('ğŸ” Ø§Ù„ØªØµÙÙŠØ©:', { school: selectedSchool || 'Ø§Ù„ÙƒÙ„', subject: data.subject });
            
            let baseData = data.raw;
            if (selectedSchool) {
                baseData = data.raw.filter(r => (r['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] === selectedSchool || r['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] === selectedSchool));
                console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙÙŠØ©:', baseData.length);
            }
            
            showDashboardFiltered(baseData);
            drawCharts(baseData);
            generateReport(baseData);
        }

        function drawCharts(baseData) {
            const latestData = baseData.filter(r => r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ'] === data.latestYear);
            let filtered = latestData;
            
            if (data.subject !== 'all') {
                filtered = filtered.filter(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === data.subject);
            }

            let html = '';
            html += '<h3 style="color: #4472C4;">Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ù…Ù„ÙƒØ©</h3>';
            html += '<div class="chart-container"><canvas id="compChart"></canvas></div>';
            html += '<h3 style="color: #4472C4;">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù† ÙÙŠ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©</h3>';
            html += '<div class="chart-container"><canvas id="domainsChart"></canvas></div>';
            html += '<h3 style="color: #4472C4;">ØªÙˆØ²ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>';
            html += '<div class="chart-container"><canvas id="levelsChart"></canvas></div>';
            html += '<h3 style="color: #4472C4;">ØªØ·ÙˆØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ø¨Ø± Ø§Ù„Ø³Ù†ÙˆØ§Øª</h3>';
            html += '<div class="chart-container"><canvas id="trendChart"></canvas></div>';

            document.getElementById('chartsContent').innerHTML = html;

            setTimeout(function() {
                drawComparisonChart(filtered);
                drawDomainsChart(filtered);
                drawLevelsChart(filtered);
                drawTrendChart(baseData);
            }, 100);
        }

        function drawComparisonChart(filtered) {
            const ctx = document.getElementById('compChart');
            if (!ctx) return;

            const subjects = data.subject === 'all' ? ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'Ø§Ù„Ø¹Ù„ÙˆÙ…'] : [data.subject];
            const schoolData = [];
            const deptData = [];
            const kingdomData = [];
            const targetData = [];
            const targetMap = {
                'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª': data.targets.math,
                'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©': data.targets.reading,
                'Ø§Ù„Ø¹Ù„ÙˆÙ…': data.targets.science
            };

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
            const schoolsSet = new Set();
            for (let i = 0; i < filtered.length; i++) {
                const schoolName = filtered[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || filtered[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];
                if (schoolName) schoolsSet.add(schoolName);
            }
            const isMultipleSchools = schoolsSet.size > 1;

            for (let i = 0; i < subjects.length; i++) {
                const subject = subjects[i];
                
                if (isMultipleSchools) {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø±Ø¬Ø­ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                    const subjectData = filtered.filter(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                    
                    let totalStudents = 0;
                    let totalProficient = 0;
                    let sumDept = 0;
                    let sumKingdom = 0;
                    let count = 0;
                    
                    for (let j = 0; j < subjectData.length; j++) {
                        const students = subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†'] || 0;
                        const proficient = subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                        totalStudents += students;
                        totalProficient += proficient;
                        sumDept += subjectData[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…'] || 0;
                        sumKingdom += subjectData[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©'] || 0;
                        count++;
                    }
                    
                    if (totalStudents > 0) {
                        schoolData.push((totalProficient / totalStudents) * 100);
                        deptData.push(count > 0 ? sumDept / count : 0);
                        kingdomData.push(count > 0 ? sumKingdom / count : 0);
                        targetData.push(targetMap[subject] || 0);
                    }
                } else {
                    // Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
                    const subjectData = filtered.find(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                    if (subjectData) {
                        schoolData.push(subjectData['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0);
                        deptData.push(subjectData['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…'] || 0);
                        kingdomData.push(subjectData['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©'] || 0);
                        targetData.push(targetMap[subject] || 0);
                    }
                }
            }

            if (data.charts.comp) data.charts.comp.destroy();

            data.charts.comp = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: subjects,
                    datasets: [
                        { label: 'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©', data: schoolData, backgroundColor: '#4472C4', borderWidth: 2, borderColor: '#2c5282' },
                        { label: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', data: deptData, backgroundColor: '#ffc107', borderWidth: 2, borderColor: '#d39e00' },
                        { label: 'Ø§Ù„Ù…Ù…Ù„ÙƒØ©', data: kingdomData, backgroundColor: '#28a745', borderWidth: 2, borderColor: '#1e7e34' },
                        { 
                            label: 'Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù', 
                            data: targetData, 
                            type: 'line',
                            borderColor: '#dc3545',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            pointRadius: 6,
                            pointBackgroundColor: '#dc3545',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        function drawDomainsChart(filtered) {
            const ctx = document.getElementById('domainsChart');
            if (!ctx) return;

            const domains = {};
            for (let i = 0; i < filtered.length; i++) {
                const r = filtered[i];
                const d = r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'];
                if (d !== r['Ø§Ù„Ù…Ø¬Ø§Ù„']) {
                    if (!domains[d]) domains[d] = [];
                    domains[d].push(r['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0);
                }
            }

            const labels = Object.keys(domains);
            const values = [];
            for (let i = 0; i < labels.length; i++) {
                values.push(avg(domains[labels[i]]));
            }

            if (data.charts.domains) data.charts.domains.destroy();

            const bgColors = [];
            for (let i = 0; i < values.length; i++) {
                if (values[i] >= 60) bgColors.push('#28a745');
                else if (values[i] >= 40) bgColors.push('#ffc107');
                else bgColors.push('#dc3545');
            }

            data.charts.domains = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù† (%)',
                        data: values,
                        backgroundColor: bgColors
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { beginAtZero: true, max: 100 } }
                }
            });
        }

        function drawLevelsChart(filtered) {
            const ctx = document.getElementById('levelsChart');
            if (!ctx) return;

            const levels = [];
            for (let i = 0; i < filtered.length; i++) {
                const r = filtered[i];
                levels.push(r['Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø±ØªÙØ¹'] || 0);
            }

            const avgHigh = avg(levels.length > 0 ? levels : [0]);
            
            const levelsMed = [];
            for (let i = 0; i < filtered.length; i++) {
                levelsMed.push(filtered[i]['Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªÙˆØ³Ø·'] || 0);
            }
            const avgMed = avg(levelsMed.length > 0 ? levelsMed : [0]);
            
            const levelsLow = [];
            for (let i = 0; i < filtered.length; i++) {
                levelsLow.push(filtered[i]['Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø®ÙØ¶'] || 0);
            }
            const avgLow = avg(levelsLow.length > 0 ? levelsLow : [0]);
            
            const levelsVLow = [];
            for (let i = 0; i < filtered.length; i++) {
                levelsVLow.push(filtered[i]['Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§'] || 0);
            }
            const avgVLow = avg(levelsVLow.length > 0 ? levelsVLow : [0]);

            if (data.charts.levels) data.charts.levels.destroy();

            data.charts.levels = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ù…Ø±ØªÙØ¹', 'Ù…ØªÙˆØ³Ø·', 'Ù…Ù†Ø®ÙØ¶', 'Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹'],
                    datasets: [{
                        data: [avgHigh, avgMed, avgLow, avgVLow],
                        backgroundColor: ['#28a745', '#36a2eb', '#ffce56', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function drawTrendChart(baseData) {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;
            
            if (!baseData) baseData = data.raw;

            const years = [...new Set(baseData.map(r => r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ']))].filter(Boolean).sort();
            const subjects = data.subject === 'all' ? ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'Ø§Ù„Ø¹Ù„ÙˆÙ…'] : [data.subject];
            
            const datasets = [];
            const colors = { 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª': '#4472C4', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©': '#28a745', 'Ø§Ù„Ø¹Ù„ÙˆÙ…': '#ffc107' };

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
            const schoolsSet = new Set();
            for (let i = 0; i < baseData.length; i++) {
                const schoolName = baseData[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || baseData[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];
                if (schoolName) schoolsSet.add(schoolName);
            }
            const isMultipleSchools = schoolsSet.size > 1;

            for (let s = 0; s < subjects.length; s++) {
                const subject = subjects[s];
                const values = [];
                
                for (let y = 0; y < years.length; y++) {
                    const year = years[y];
                    const yearData = baseData.filter(r => r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ'] === year);
                    
                    if (isMultipleSchools) {
                        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø±Ø¬Ø­
                        const subjectData = yearData.filter(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                        let totalStudents = 0;
                        let totalProficient = 0;
                        
                        for (let j = 0; j < subjectData.length; j++) {
                            totalStudents += subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†'] || 0;
                            totalProficient += subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                        }
                        
                        values.push(totalStudents > 0 ? (totalProficient / totalStudents) * 100 : 0);
                    } else {
                        // Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ø­Ø¯Ø©
                        const subjectData = yearData.find(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                        values.push(subjectData ? (subjectData['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0) : 0);
                    }
                }

                datasets.push({
                    label: subject,
                    data: values,
                    borderColor: colors[subject],
                    backgroundColor: colors[subject] + '20',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true
                });
            }

            if (data.charts.trend) data.charts.trend.destroy();

            data.charts.trend = new Chart(ctx, {
                type: 'line',
                data: { labels: years, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        } 
                    }
                }
            });
        }

        function generateReport(baseData) {
            if (!baseData) baseData = data.raw;
            const latestData = baseData.filter(r => r['Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…ÙŠÙ„Ø§Ø¯ÙŠ'] === data.latestYear);
            let filtered = latestData;
            
            if (data.subject !== 'all') {
                filtered = filtered.filter(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === data.subject);
            }

            const subjects = data.subject === 'all' ? ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'Ø§Ù„Ø¹Ù„ÙˆÙ…'] : [data.subject];
            const targetMap = {
                'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª': data.targets.math,
                'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©': data.targets.reading,
                'Ø§Ù„Ø¹Ù„ÙˆÙ…': data.targets.science
            };

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
            const schoolsSet = new Set();
            for (let i = 0; i < baseData.length; i++) {
                const schoolName = baseData[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || baseData[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];
                if (schoolName) schoolsSet.add(schoolName);
            }
            const isMultipleSchools = schoolsSet.size > 1;

            const analysis = analyzeData(filtered, subjects, targetMap, isMultipleSchools);

            let html = '<div class="report-section">';
            html += '<div class="report-header">';
            html += '<h1>' + data.school + '</h1>';
            html += '<h2>ØªÙ‚Ø±ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ù†Ø§ÙØ³ Ø§Ù„ÙˆØ·Ù†ÙŠØ©</h2>';
            html += '<h3>Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: ' + data.latestYear + '</h3>';
            html += '</div>';
            html += '<div class="report-stats">';
            
            for (let i = 0; i < subjects.length; i++) {
                const subject = subjects[i];
                let perf = 0;
                
                if (isMultipleSchools) {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø±Ø¬Ø­
                    const subjectData = latestData.filter(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                    let totalStudents = 0;
                    let totalProficient = 0;
                    
                    for (let j = 0; j < subjectData.length; j++) {
                        totalStudents += subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†'] || 0;
                        totalProficient += subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                    }
                    
                    if (totalStudents > 0) {
                        perf = (totalProficient / totalStudents) * 100;
                    }
                } else {
                    // Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ø­Ø¯Ø©
                    const s = latestData.find(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                    if (s) perf = s['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                }
                
                if (perf > 0 || isMultipleSchools) {
                    html += '<div class="report-stat">';
                    html += '<h3>' + subject + '</h3>';
                    html += '<h2>' + perf.toFixed(1) + '%</h2>';
                    html += '<p>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: ' + targetMap[subject] + '%</p>';
                    html += '</div>';
                }
            }
            
            html += '</div></div>';
            
            html += '<div class="report-section"><div class="strengths-box">';
            html += '<h3>âœ… Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©</h3><ul>';
            for (let i = 0; i < analysis.strengths.length; i++) {
                html += '<li>' + analysis.strengths[i] + '</li>';
            }
            html += '</ul></div></div>';
            
            html += '<div class="report-section"><div class="weaknesses-box">';
            html += '<h3>âš ï¸ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù</h3><ul>';
            for (let i = 0; i < analysis.weaknesses.length; i++) {
                html += '<li>' + analysis.weaknesses[i] + '</li>';
            }
            html += '</ul></div></div>';
            
            html += '<div class="report-section"><div class="recommendations-box">';
            html += '<h3>ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ§Øª</h3><ol>';
            for (let i = 0; i < analysis.recommendations.length; i++) {
                html += '<li>' + analysis.recommendations[i] + '</li>';
            }
            html += '</ol></div></div>';
            
            html += '<div class="report-section">';
            html += '<h3 style="color: #4472C4; text-align: center;">Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</h3>';
            html += '<div class="chart-container"><canvas id="reportChart1"></canvas></div>';
            html += '<div class="chart-container"><canvas id="reportChart2"></canvas></div>';
            html += '</div>';

            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('reportPreview').innerHTML = html;

            setTimeout(function() {
                drawReportCharts(filtered);
            }, 100);
        }

        function analyzeData(filtered, subjects, targetMap, isMultipleSchools) {
            const strengths = [];
            const weaknesses = [];
            const recommendations = [];

            for (let i = 0; i < subjects.length; i++) {
                const subject = subjects[i];
                let perf = 0;
                let dept = 0;
                
                if (isMultipleSchools) {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø±Ø¬Ø­
                    const subjectData = filtered.filter(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                    let totalStudents = 0;
                    let totalProficient = 0;
                    let sumDept = 0;
                    let count = 0;
                    
                    for (let j = 0; j < subjectData.length; j++) {
                        totalStudents += subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†'] || 0;
                        totalProficient += subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                        sumDept += subjectData[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…'] || 0;
                        count++;
                    }
                    
                    if (totalStudents > 0) {
                        perf = (totalProficient / totalStudents) * 100;
                        dept = count > 0 ? sumDept / count : 0;
                    }
                } else {
                    // Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ø­Ø¯Ø©
                    const subjectData = filtered.find(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                    if (!subjectData) continue;
                    perf = subjectData['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                    dept = subjectData['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…'] || 0;
                }

                const target = targetMap[subject];

                if (perf >= target) {
                    strengths.push('Ù…Ø§Ø¯Ø© ' + subject + ' Ø­Ù‚Ù‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ø¨Ù†Ø³Ø¨Ø© ' + perf.toFixed(1) + '%');
                }
                if (perf > dept) {
                    strengths.push('Ù…Ø§Ø¯Ø© ' + subject + ' ØªÙÙˆÙ‚Øª Ø¹Ù„Ù‰ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (' + dept.toFixed(1) + '%)');
                }

                if (perf < target) {
                    const gap = (target - perf).toFixed(1);
                    weaknesses.push('Ù…Ø§Ø¯Ø© ' + subject + ' Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ø¨Ù€ ' + gap + '%');
                    recommendations.push('ØªÙ†ÙÙŠØ° Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙ‚ÙˆÙŠØ© Ù…ÙƒØ«Ù ÙÙŠ ' + subject + ' Ù„ØªÙ‚Ù„ÙŠØµ Ø§Ù„ÙØ¬ÙˆØ©');
                }
                if (perf < dept) {
                    weaknesses.push('Ù…Ø§Ø¯Ø© ' + subject + ' Ø£Ù‚Ù„ Ù…Ù† Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
                }
            }

            const domains = {};
            for (let i = 0; i < filtered.length; i++) {
                const r = filtered[i];
                const d = r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'];
                if (d !== r['Ø§Ù„Ù…Ø¬Ø§Ù„']) {
                    domains[d] = r['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                }
            }

            const sortedDomains = Object.entries(domains).sort(function(a, b) { return b[1] - a[1]; });
            if (sortedDomains.length > 0 && !isMultipleSchools) {
                strengths.push('Ø£ÙØ¶Ù„ Ù…Ø¬Ø§Ù„ ÙØ±Ø¹ÙŠ: ' + sortedDomains[0][0] + ' Ø¨Ù†Ø³Ø¨Ø© ' + sortedDomains[0][1] + '%');
                
                const weakest = sortedDomains[sortedDomains.length - 1];
                if (weakest[1] < 50) {
                    weaknesses.push('Ø£Ø¶Ø¹Ù Ù…Ø¬Ø§Ù„: ' + weakest[0] + ' Ø¨Ù†Ø³Ø¨Ø© ' + weakest[1] + '%');
                    recommendations.push('Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† ' + weakest[0] + ' ÙƒØ£ÙˆÙ„ÙˆÙŠØ©');
                }
            }

            if (strengths.length === 0) {
                strengths.push('ÙŠÙˆØ¬Ø¯ Ù…Ø¬Ø§Ù„ Ù„Ù„ØªØ­Ø³ÙŠÙ† ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯');
            }

            return { strengths: strengths, weaknesses: weaknesses, recommendations: recommendations };
        }

        function drawReportCharts(filtered) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
            const schoolsSet = new Set();
            for (let i = 0; i < filtered.length; i++) {
                const schoolName = filtered[i]['Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] || filtered[i]['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'];
                if (schoolName) schoolsSet.add(schoolName);
            }
            const isMultipleSchools = schoolsSet.size > 1;
            
            const ctx1 = document.getElementById('reportChart1');
            if (ctx1) {
                const subjects = data.subject === 'all' ? ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'Ø§Ù„Ø¹Ù„ÙˆÙ…'] : [data.subject];
                const schoolData = [];
                const deptData = [];

                for (let i = 0; i < subjects.length; i++) {
                    const subject = subjects[i];
                    
                    if (isMultipleSchools) {
                        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø±Ø¬Ø­
                        const subjectData = filtered.filter(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                        let totalStudents = 0;
                        let totalProficient = 0;
                        let sumDept = 0;
                        let count = 0;
                        
                        for (let j = 0; j < subjectData.length; j++) {
                            totalStudents += subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†'] || 0;
                            totalProficient += subjectData[j]['Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0;
                            sumDept += subjectData[j]['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…'] || 0;
                            count++;
                        }
                        
                        if (totalStudents > 0) {
                            schoolData.push((totalProficient / totalStudents) * 100);
                            deptData.push(count > 0 ? sumDept / count : 0);
                        }
                    } else {
                        // Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ø­Ø¯Ø©
                        const s = filtered.find(r => r['Ø§Ù„Ù…Ø¬Ø§Ù„'] === subject && r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'] === subject);
                        if (s) {
                            schoolData.push(s['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0);
                            deptData.push(s['Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…'] || 0);
                        }
                    }
                }

                new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: subjects,
                        datasets: [
                            { label: 'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©', data: schoolData, backgroundColor: '#4472C4' },
                            { label: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', data: deptData, backgroundColor: '#ffc107' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' } },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            }

            const ctx2 = document.getElementById('reportChart2');
            if (ctx2) {
                const domains = {};
                for (let i = 0; i < filtered.length; i++) {
                    const r = filtered[i];
                    const d = r['Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ'];
                    if (d !== r['Ø§Ù„Ù…Ø¬Ø§Ù„']) {
                        if (!domains[d]) domains[d] = [];
                        domains[d].push(r['Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†'] || 0);
                    }
                }

                const labels = Object.keys(domains);
                const values = [];
                for (let i = 0; i < labels.length; i++) {
                    values.push(avg(domains[labels[i]]));
                }

                const bgColors = [];
                for (let i = 0; i < values.length; i++) {
                    if (values[i] >= 60) bgColors.push('#28a745');
                    else if (values[i] >= 40) bgColors.push('#ffc107');
                    else bgColors.push('#dc3545');
                }

                new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù†',
                            data: values,
                            backgroundColor: bgColors
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©' } },
                        scales: { x: { beginAtZero: true, max: 100 } }
                    }
                });
            }
        }

        function avg(arr) {
            if (!arr || arr.length === 0) return 0;
            let sum = 0;
            for (let i = 0; i < arr.length; i++) {
                sum += arr[i];
            }
            return sum / arr.length;
        }

        function switchTab(i) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            for (let j = 0; j < tabs.length; j++) {
                if (j === i) {
                    tabs[j].classList.add('active');
                    contents[j].classList.add('active');
                } else {
                    tabs[j].classList.remove('active');
                    contents[j].classList.remove('active');
                }
            }
        }

        function showStatus(msg, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="alert alert-' + type + '">' + msg + '</div>';
            setTimeout(function() {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        function printReport() {
            const reportContent = document.getElementById('reportContent');
            if (!reportContent || !reportContent.innerHTML.trim()) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                return;
            }
            
            // ØªØ­ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Canvas Ø¥Ù„Ù‰ ØµÙˆØ±
            const canvases = reportContent.getElementsByTagName('canvas');
            const images = [];
            
            for (let i = 0; i < canvases.length; i++) {
                const canvas = canvases[i];
                const img = document.createElement('img');
                img.src = canvas.toDataURL('image/png');
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.className = 'chart-print-image';
                
                // Ø¥Ø®ÙØ§Ø¡ Canvas ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©
                canvas.style.display = 'none';
                canvas.parentNode.insertBefore(img, canvas);
                images.push({ canvas: canvas, img: img });
            }
            
            // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            setTimeout(function() {
                window.print();
                
                // Ø¥Ø¹Ø§Ø¯Ø© Canvas ÙˆØ­Ø°Ù Ø§Ù„ØµÙˆØ±
                setTimeout(function() {
                    for (let i = 0; i < images.length; i++) {
                        images[i].canvas.style.display = 'block';
                        if (images[i].img.parentNode) {
                            images[i].img.parentNode.removeChild(images[i].img);
                        }
                    }
                }, 100);
            }, 500);
        }

        function exportPDF() {
            const element = document.getElementById('reportContent');
            if (!element || !element.innerHTML.trim()) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                return;
            }
            
            // ØªØ­ÙˆÙŠÙ„ Canvas Ø¥Ù„Ù‰ ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹
            const canvases = element.getElementsByTagName('canvas');
            const images = [];
            
            for (let i = 0; i < canvases.length; i++) {
                const canvas = canvases[i];
                const img = document.createElement('img');
                img.src = canvas.toDataURL('image/png');
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                
                canvas.style.display = 'none';
                canvas.parentNode.insertBefore(img, canvas);
                images.push({ canvas: canvas, img: img });
            }
            
            // ØªØµØ¯ÙŠØ± PDF
            setTimeout(function() {
                const opt = {
                    margin: 10,
                    filename: 'ØªÙ‚Ø±ÙŠØ±_' + data.school + '_' + data.latestYear + '.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save().then(function() {
                    // Ø¥Ø¹Ø§Ø¯Ø© Canvas Ø¨Ø¹Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ±
                    for (let i = 0; i < images.length; i++) {
                        images[i].canvas.style.display = 'block';
                        if (images[i].img.parentNode) {
                            images[i].img.parentNode.removeChild(images[i].img);
                        }
                    }
                });
            }, 500);
        }
    </script>
</body>
</html>
